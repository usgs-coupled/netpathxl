  ! This software AUTODICE.F90 is part of the Compaq Visual Fortran kit.
  ! Copyright (C) 1997,1999 Digital Equipment Corporation.
  ! All rights reserved.
  ! 
  ! This software is furnished to you under a license by  Digital Equipment
  ! Corporation and must be used only in  accordance with the terms and conditions
  ! of that license,  and only with the inclusion of the above copyright notice.
  ! 
  ! This software is provided as an example that demonstrates a particular
  ! feature/function of the licensed product. The software is not intended to
  ! provide a complete solution to any application problem but rather is provided
  ! as a teaching mechanism.
  ! 
  ! Users may incorporate any part of this sample into their own source after 
  ! making appropriate changes to make it suitable for the intended application.

  ! This sample program takes 12 numbers and uses
  ! Automation to tell EXCEL 97 to draw a histogram of the numbers.
  ! The EXCEL97A module generated by the Fortran Module Wizard
  ! is used as the interface to EXCEL.  EXCEL97A supports the following EXCEL
  ! interfaces:
  !     _Application, _Chart, _Workbook, _Worksheet, Axes, Charts, Range,
  !     Workbooks, Worksheets
  !
  ! NOTES: 
  !     1.  Modify the file specification below if you have installed Visual
  !         Fortran in a directory other than 
  !         C:\PROGRAM FILES\MICROSOFT VISUAL STUDIO
  !     2.  After running this sample, if you save the changes to HISTO.XLS,
  !         you must re-copy the original version from the Visual Fortran 
  !         CD-ROM for this sample to work correctly.
  !

	Subroutine NewExcel
      USE filenames
      USE max_size
	  USE IFCOM
	  USE ADOBJECTS
	  USE excel_headings
	  
	  IMPLICIT NONE   
	  integer lens
	  external lens                 

	! Variables
	  INTEGER*4 status
	  TYPE (VARIANT) :: template
	  INTEGER*4 loopCount
	  INTEGER*4 die1
	  INTEGER*4 die2
	  INTEGER*4 roll
	  INTEGER*4 maxScale
	  CHARACTER (LEN = 32) :: loopc
	  INTEGER*4   i, j
	  LOGICAL*2 l
	  REAL*4    rnd
	  INTEGER*2, DIMENSION(1:12) :: cellCounts
	  integer*4 excelapp1
	  character*10 cell_location

	! Variant arguments
	  TYPE (VARIANT) :: vBSTR1
	  TYPE (VARIANT) :: vBSTR2
	  TYPE (VARIANT) :: vBSTR3
	  TYPE (VARIANT) :: vBSTR4
	  TYPE (VARIANT) :: vBSTR5

	  TYPE (VARIANT) :: vInt

	! Initialize object pointers
	  CALL INITOBJECTS()

	! Create an Excel object
	  CALL COMINITIALIZE(status)
	  CALL COMCreateObjectByProgID("Excel.Application", excelapp, status)
!      CALL COMCREATEOBJECT ("Excel.Application", excelapp, status)
	  IF (excelapp == 0) THEN
		  WRITE (*, '(" Unable to create Excel object; Aborting")')
		  CALL EXIT()
	  END IF
	  l = .FALSE.
	  CALL $Application_SetVisible(excelapp, l)

	! Here is a sketch of the code below in pseudocode...
	!
	!	workbooks = excelapp.GetWorkbooks()
	!	workbook = workbooks.Open(spreadsheet)
	!	worksheet = workbook.GetActiveSheet
	!	range = worksheet.GetRange("A1", "L1")
	!	range.Select()
	!	charts = workbook.GetCharts()
	!	chart = charts.Add()
	!	chart.ChartWizard(gallery=chartType, title=title, categoryTitle=title, valueTitle=title)
	!	valueAxis = chart.Axes(type=xlValue, axisGroup=xlPrimary)
	!   valueAxis.MaximumScale(loopcount/5)

	! Get the WORKBOOKS object
	  workbooks = $Application_GetWorkbooks(excelapp, status)
	  CALL Check_Status(status, " Unable to get WORKBOOKS object")

	! Open the specified spreadsheet file (note: specify the full file path)
	!  workbook = Workbooks_Open(workbooks, &
	!    "C:\PROGRAM FILES\MICROSOFT VISUAL STUDIO\DF98\SAMPLES\ADVANCED\COM\AUTODICE\HISTO.XLS", &
	!    $STATUS = status)
	  workbook = Workbooks_Add(workbooks,$STATUS = status )
	  CALL Check_Status(status, " Unable to get WORKBOOK object; ensure that the file path is correct")
 
	! Get the worksheet
	  vInt%VT = VT_I4
	  vInt%VU%LONG_VAL = 1
	  worksheet = $Workbook_GetActiveSheet(workbook, status)
	  CALL Check_Status(status, " Unable to get WORKSHEET object")

	! Set header character strings
	  colheadings(2,5) = "Alk/" // Char(10) // "TDIC Flag"
	  do i = 1, 21
		call setcell_character(headings(1,i), headings(2,i))
	  enddo

	! Set column header character strings
	  do i = 1, count_colheadings
		call setcell_character(colheadings(1,i), colheadings(2,i))
	  enddo

	  ! Initialize well numbers
!	  DO i=1,2
!		write(cell_location,'("a",i1)') i+7
!		call setcell_integer(cell_location, i)
!	  END DO
!	  DO i=3,50
!		write(cell_location,'("a",i2)') i+7
!		call setcell_integer(cell_location, i)
!	  END DO
	  DO i=1, MAXWELLS
	  
		write(cell_location,'(i5)') i+7
		do j = 1, 4
		    if (cell_location(1:1) .eq. ' ') then
		        cell_location = cell_location(2:5)
		    endif
		enddo
		cell_location = 'a'//cell_location
		call setcell_integer(cell_location, i)
	  END DO

	  ! set width for well name
	  call set_range('b1','b1')
	  CALL VariantInit(vBSTR1)
	  vBSTR1%VT = VT_R4
	  vBSTR1%VU%FLOAT_VAL = 30.
	  call range_setcolumnwidth(range, vBSTR1, status)
	  CALL Check_Status(status, " Unable to set column width")
	  status = VariantClear(vBSTR1)
	  bstr1 = 0

	  ! set width for flags
	  call set_range('c1','f1')
	  CALL VariantInit(vBSTR1)
	  vBSTR1%VT = VT_R4
	  vBSTR1%VU%FLOAT_VAL = 4.29
	  call range_setcolumnwidth(range, vBSTR1, status)
	  CALL Check_Status(status, " Unable to set column width")
	  status = VariantClear(vBSTR1)
	  bstr1 = 0

		   ! set width for well name
	  call set_range('be7','bi7')
	  CALL VariantInit(vBSTR1)
	  vBSTR1%VT = VT_R4
	  vBSTR1%VU%FLOAT_VAL = 20.
	  call range_setcolumnwidth(range, vBSTR1, status)
	  CALL Check_Status(status, " Unable to set column width")
	  status = VariantClear(vBSTR1)
	  bstr1 = 0

	  ! set wrap and center on row 7
	  call set_range('a7','bg7')
	  call set_variant_bool(vARG1, .true.)
	  call range_SetWrapText(range, vARG1, status)
	  call set_variant_int(vARG1, -4108)
	  call range_SetHorizontalAlignment(range, vARG1, status)
	  CALL Check_Status(status, " Unable to set horizontal alignment")

	  ! Set default protection false
	  range = $worksheet_getcells(worksheet, status)
	  CALL Check_Status(status, " Unable to set range to all cells")
	  call set_variant_bool(vARG1, .false.)
	  call range_setlocked(range, vARG1, status)
	  !Set protection on Headers
	  call set_range('a1','au7')
	  call set_variant_bool(vARG1, .true.)
	  call range_setlocked(range, vARG1, status)
 
	  !Set protection on worksheet
	  call $worksheet_protect(worksheet)

	  !Save workbook
	  !string = path(1:lens(path)) // '\' // dfile(1:lens(dfile)) // '.xls'
	  !call set_variant_char(vARG1, string)
	  !call $workbook_saveas(workbook, vARG1)
	  !CALL Check_Status(status, " Unable to save workbook")


!    Cells.Select
!    Selection.Locked = False
!    Selection.FormulaHidden = False
!    Range("A1:AS7").Select
!    Range("A7").Activate
!    Selection.Locked = True
!    Selection.FormulaHidden = False
!    ActiveSheet.Protect DrawingObjects:=True, Contents:=True, Scenarios:=True _
!        , AllowFormattingCells:=True, AllowFormattingColumns:=True, _
!        AllowFormattingRows:=True, AllowInsertingRows:=True, AllowDeletingColumns _
!        :=True, AllowDeletingRows:=True, AllowSorting:=True


	! Release all objects
	!  CALL RELEASEOBJECTS()
	!  CALL COMUNINITIALIZE()

	END subroutine NewExcel
!
!
!
	Subroutine SaveExcel

	  USE ADOBJECTS
	  USE filenames
	  
	  IMPLICIT NONE   	  !Save workbook
	  CHARACTER*256 string
      CHARACTER*2048 version_string
      double precision ver
	  integer lens
	  integer*4 status
	  external lens   
	  version_string = $Application_GetVersion(excelapp, status)
      READ(version_string,'(F)') ver
      if (ver < 12.0) then
          file_suffix = '.xls'
      endif
	  !string = path(1:lens(path)) // '\' // root(1:lens(root)) // '.xls'
      string = path(1:lens(path)) // '\' // root(1:lens(root)) // '.' // trim(file_suffix)
	  call set_variant_char(vARG1, string)
	  call set_variant_char(vARG2, '')
	  call $workbook_saveas(workbook, vARG1)
	  CALL Check_Status(status, " Unable to save workbook")!
	return
	end subroutine SaveExcel
!
!
!
Subroutine OldExcel

	USE ADOBJECTS
	use filenames
	
	IMPLICIT NONE   
	  integer lens
	  external lens                 
	  CHARACTER*256 string

	! Variables
	  INTEGER*4 status
	  logical*2 l
	  TYPE (VARIANT) :: vInt


	! Initialize object pointers
	  CALL INITOBJECTS()

	! Create an Excel object
	  CALL COMINITIALIZE(status)
	  CALL COMCreateObjectByProgID("Excel.Application", excelapp, status)
!      CALL COMCREATEOBJECT ("Excel.Application", excelapp, status)
	  IF (excelapp == 0) THEN
		  WRITE (*, '(" Unable to create Excel object; Aborting")')
		  CALL EXIT()
	  END IF
	  CALL Check_Status(status, " Unable to create Excel application")
	  
	  l = .FALSE.
	  CALL $Application_SetVisible(excelapp, l)

	! Get the WORKBOOKS object
	  workbooks = $Application_GetWorkbooks(excelapp, status)
	  CALL Check_Status(status, " Unable to get WORKBOOKS object")

	! Open the specified spreadsheet file (note: specify the full file path)
	filename = path(1:lens(path)) // '\' // root(1:lens(root)) // '.' // trim(file_suffix)
	workbook = Workbooks_Open(workbooks, &
		filename, &
		$STATUS = status)

	  CALL Check_Status(status, " Unable to get WORKBOOK object; ensure that the file path is correct")
 
	! Get the worksheet
	  vInt%VT = VT_I4
	  vInt%VU%LONG_VAL = 1
	  worksheet = $Workbook_GetActiveSheet(workbook, status)
	  CALL Check_Status(status, " Unable to get WORKSHEET object")

	END subroutine OldExcel
!
!
!
	logical function CheckOldExcel

	  USE ADOBJECTS
	  USE excel_headings
	  
	  IMPLICIT NONE   
	  integer lens
	  external lens                 
	  CHARACTER*256 string

	! Variables
	  INTEGER*4 status
	  INTEGER*4 loopCount
	  INTEGER*4 die1
	  INTEGER*4 die2
	  INTEGER*4 roll
	  INTEGER*4 maxScale
	  logical npxlfile
	  INTEGER*4   i
	  REAL*4    rnd
	  INTEGER*2, DIMENSION(1:12) :: cellCounts
	  integer*4 excelapp1
	
	  character*10 cell_location

	! Variant arguments
	  TYPE (VARIANT) :: vBSTR1
	  TYPE (VARIANT) :: vBSTR2
	  TYPE (VARIANT) :: vBSTR3
	  TYPE (VARIANT) :: vBSTR4
	  TYPE (VARIANT) :: vBSTR5

	  TYPE (VARIANT) :: vInt


 
	  colheadings(2,5) = "Alk/" // Char(10) // "TDIC Flag"
	! Check cell a1
	 npxlfile = .true.
	 do i = 1, 1
		call set_range(headings(1,1),headings(1,1))
		status = AUTOGETPROPERTY (range, "VALUE", string)
		CALL Check_Status(status, "Read cell")
		if (string .ne. headings(2,1)) then
			npxlfile = .false.
			exit
		endif
	  enddo

	! Set column header character strings
	  do i = 1, count_colheadings
		call set_range(colheadings(1,i),colheadings(1,i))
		status = AUTOGETPROPERTY (range, "VALUE", string)
		CALL Check_Status(status, "Read cell")
		if (string .ne. colheadings(2,i)(1:lens(string))) then
			npxlfile = .false.
			exit
		endif
		if (colheadings(1,i) == 'au7') then
			exit
		endif
	  enddo

	CheckOldExcel = npxlfile
	if (npxlfile) then
!		CALL $Application_SetVisible(excelapp, .TRUE.)
	else
		CALL $Application_quit(excelapp, status)
		CALL Check_Status(status, "Quit Excel on incorrect file.")
	endif
	END function CheckOldExcel
!
!
!
	subroutine VisibleExcel(switch) 
	  USE ADOBJECTS

	  IMPLICIT NONE   
		  
	  CHARACTER*256 string

	! Variables
	  logical switch
	  integer*4 status
	  logical*2 l
	  
	  l = switch

	CALL $Application_SetVisible(excelapp, l)

	END subroutine VisibleExcel 
!
!
!
SUBROUTINE cleanup_com(terminate)

	USE ADOBJECTS

	INTEGER*4 status
	logical terminate

	if (terminate) then
		CALL $Application_Quit(excelapp, status)
		CALL Check_Status(status, "Quit Excel failed.")
	endif
	! Release all objects
	CALL RELEASEOBJECTS()
	CALL COMUNINITIALIZE()
	RETURN
    END subroutine cleanup_com
    
SUBROUTINE cleanup_comA0(terminate)

	USE ADOBJECTS

	INTEGER*4 status
	logical terminate

	if (terminate) then
		CALL $Application_Quit(excelappA0, status)
		CALL Check_Status(status, "Quit Excel failed.")
	endif
	! Release all objects
	CALL RELEASEOBJECTSA0()
	CALL COMUNINITIALIZE()
	RETURN
END subroutine cleanup_comA0    

	SUBROUTINE Check_Status(olestatus, errorMsg)
	  USE ADOBJECTS
	  IMPLICIT NONE                       

	  INTEGER*4 olestatus
	  CHARACTER (LEN = *) :: errorMsg

	  IF (olestatus >= 0) THEN
		  RETURN
	  END IF

	! Error handling code

	  WRITE (*, '(A, "; OLE error status = 0x", Z8.8, "; Aborting")') TRIM(errorMsg), olestatus
	  CALL SLEEPQQ(5000)
	  
	  CALL RELEASEOBJECTS()
	  CALL EXIT(-1)

	END SUBROUTINE
	!
!
!
SUBROUTINE DB2XL
  USE max_size
  use filenames
  USE ADOBJECTS
  IMPLICIT NONE
  CHARACTER*16 words(45)
  CHARACTER*1 UPCS, ans
  CHARACTER*80 line
  CHARACTER*20 frmt
  CHARACTER*10 piece
  CHARACTER*80 funame, char_linenum, cell_location
  INTEGER LENS, n, i, jcounter, k, j, kk, linenum
  !
  REAL Dbdata
  COMMON /DB    / Dbdata(MAXWELLS,45)
  INTEGER Dbsfg, Idefault, Iu, Nwlls, Totwell, Tot
  COMMON /INT4DB/ Dbsfg(MAXWELLS,45), Idefault(5), Iu(MAXWELLS,4), Nwlls,  &
	   Totwell, Tot(MAXWELLS)
  CHARACTER Wllnms*80, Address*40, Lat*40, Formation*17
  COMMON /CHAR1 / Wllnms(MAXWELLS), Address(MAXWELLS,5), Lat(MAXWELLS), Formation(MAXWELLS)
  INTEGER Icase, Iw1, Iw2, Ir, Iex1, Io1, Iscr2
  COMMON /FUNITS/ Icase, Iw1, Iw2, Ir, Iex1, Io1, Iscr2

  !
  EXTERNAL LENS, UPCS
  INTRINSIC CHAR, ICHAR
  !
  DATA words/'Temperature     ', 'pH              ',  &
	   'Dissolved Oxygen', 'Alkalinity      ', 'Tritium         ',  &
	   'H2S as S        ', 'Calcium         ', 'Eh              ',  &
	   'Magnesium       ', 'Sodium          ', 'Potassium       ',  &
	   'Chloride        ', 'Sulfate         ', 'Fluoride        ',  &
	   'Silica          ', 'Bromide         ', 'Boron           ',  &
	   'Barium          ', 'Lithium         ', 'Strontium       ',  &
	   'Iron            ', 'Manganese       ', 'Nitrate         ',  &
	   'Ammonium        ', 'Phosphate       ', 'DOC             ',  &
	   'Sp. Cond.       ', 'Density         ', 'Delta C-13 TDIC ',  &
	   'Carbon 14 TDIC  ', 'Delta S-34 (SO4)', 'Delta S-34 (H2S)',  &
	   'Delta Deuterium ', 'Delta O-18      ', 'CH4 (aq)        ',  &
	   'Sr 87/86        ', 'Aluminum        ', 'N2 (aq)         ',  &
	   'N-15 of N2 (aq) ', 'N-15 of Nitrate ', 'N-15 of Ammonium',  &
	   'Depth           ', 'Casing          ', 'Elevation       ',  &
	   'RS of DOC       '/
  character*2 location(45)
  data location/' G', ' H', &
		'AD', ' P', 'AO', &
		'AE', ' J', ' I', &
		' K', ' L', ' M', &
		' N', ' O', ' T', &
		' U', ' V', ' W', &
		' X', ' Y', ' Z', &
		' Q', ' R', 'AA', &
		'AB', 'AC', 'AH', &
		'AV', 'AU', 'AJ', &
		'AK', 'AL', 'AM', &
		'AN', 'AP', 'AG', &
		'AQ', ' S', 'AF', &
		'AR', 'AS', 'AT', &
		'BB', 'BC', 'BD', &
		'AI'/
  !
  WRITE (*,*) 'Translating .lon to Excel ...'
  funame = root(1:LENS(root))//'.lon'
70 CONTINUE
  !
  !   Open file
  !
!  OPEN (Iw1,FILE=funame)
!  WRITE (Iw1,'(A,T60,"# File format")',ERR=50) "2.14"
  !
  !   Save each well
  ! 
  linenum = 8
  DO n = 1, Nwlls
	write(char_linenum,'(i2)') linenum
	if (char_linenum(1:1) == ' ') then
		char_linenum = char_linenum(2:2)
	endif
	 !   write(cell_location,'("a",i1)') i+7
	 !       Wellnms
	 ! WRITE (Iw1,9005,ERR=50) Iu(n,1), Iu(n,2), Iu(n,3), Iu(n,4),  &
	 !     Wllnms(n)(5:80)
!9005 FORMAT (4(I1),A76)
	 cell_location = "B" // char_linenum
	 call setcell_character(cell_location, wllnms(n)(5:80))
	 cell_location = "C" // char_linenum
	 call setcell_integer(cell_location, iu(n,1))
	 cell_location = "D" // char_linenum
	 call setcell_integer(cell_location, iu(n,2))
	 cell_location = "E" // char_linenum
	 call setcell_integer(cell_location, iu(n,3))
	 cell_location = "F" // char_linenum
	 call setcell_integer(cell_location, iu(n,4))
	 !       Lat/lon
	 !WRITE (Iw1,'(a40,T60,"# Lat/lon")') Lat(n)
	 cell_location = "AZ" // char_linenum
	 call setcell_character(cell_location, lat(n))
	 !       Well num
	 !WRITE (Iw1,'(I15,T60,"# Well number")') Tot(n)
	 cell_location = "A" // char_linenum
	 call setcell_integer(cell_location, tot(n))
	 !       Total number of wells
	 !WRITE (Iw1,'(I15,T60,"# Total wells")') Totwell
	 !DO i = 1, 5
		!       Address
		!WRITE (Iw1,'(A,T60,"# Address",I1)') Address(n,i), i
	 !enddo		
	 cell_location = "BE" // char_linenum
	 call setcell_character(cell_location, address(n,1))
	 cell_location = "BF" // char_linenum
	 call setcell_character(cell_location, address(n,2))
	 cell_location = "BG" // char_linenum
	 call setcell_character(cell_location, address(n,3))
	 cell_location = "BH" // char_linenum
	 call setcell_character(cell_location, address(n,4))
	 cell_location = "BI" // char_linenum
	 call setcell_character(cell_location, address(n,5))
	 jcounter = 41
	 !do j = 1, jcounter 
	 !   IF (Dbsfg(n,j).GE.0) THEN
	 !      frmt = '(F15.'//CHAR(ICHAR('0')+Dbsfg(n,j))// &
	 !           ',T60,"# ",A)'
	 !      WRITE(Iw1,frmt) Dbdata(n,j), words(j)
	 !   ELSE IF (Dbsfg(n,j).EQ.-2) THEN
	 !      WRITE(Iw1,'("<",F14.3,T60,"# ",A)') Dbdata(n,j), words(j)
	 !   ELSE
	 !      WRITE(Iw1,'("               ",T60,"# ",A)') words(j)
	 !   END IF
	 !enddo     ! 1 well
	 do j = 1, 45
		cell_location = location(j) // char_linenum
		call setcell_float(cell_location, dbdata(n,j), dbsfg(n,j))
	 enddo
	 !WRITE (Iw1,'(A,T60,"# Formation")') Formation(n)
	 linenum = linenum + 1
  enddo       ! all wells
 ! close (Iw1)
  return
50 CONTINUE
  !
  !     Error writing to file, probably write protected
  !
  WRITE (*,9030) funame
80 WRITE (*,9040)
  READ (*,9000,ERR=80) ans
  call moverelative(-2)
  call clpart 
  IF (UPCS(ans).EQ.'Y') THEN
	 CLOSE (Iw1, STATUS='DELETE')
	 GOTO 70
  ELSE IF (UPCS(ans).NE.'N') THEN
	 GOTO 80
  END IF
  !
  RETURN
9000 FORMAT (A)
9010 FORMAT (A40,24X,'#',I5,' of ',I5)
9015 FORMAT ('<',F9.3)
9020 FORMAT (A17)
9030 FORMAT ('WARNING: Error writing to file: ',A40/ &
	   'File may be write protected.'/)
9040 FORMAT ('Do you want to OVERWRITE the file (y or n)?')
END SUBROUTINE db2xl
!
!
!
SUBROUTINE XL2DB
    USE max_size
    USE ADOBJECTS
    use oleaut32
    use ifcom

    IMPLICIT NONE
    INTEGER*4 status
    character*256 string
    character*256 strings(4)
    CHARACTER*16 words(45)
    CHARACTER*1 UPCS, ans
    CHARACTER*80 line
    CHARACTER*20 frmt
    CHARACTER*10 piece
    CHARACTER*80 funame, char_linenum, cell_location
    INTEGER LENS, n, i, jcounter, k, j, kk, linenum
    !
    REAL Dbdata
    COMMON /DB    / Dbdata(MAXWELLS,45)
    INTEGER Dbsfg, Idefault, Iu, Nwlls, Totwell, Tot
    COMMON /INT4DB/ Dbsfg(MAXWELLS,45), Idefault(5), Iu(MAXWELLS,4), Nwlls,  &
       Totwell, Tot(MAXWELLS)
    CHARACTER Wllnms*80, Address*40, Lat*40, Formation*17
    COMMON /CHAR1 / Wllnms(MAXWELLS), Address(MAXWELLS,5), Lat(MAXWELLS), Formation(MAXWELLS)
    INTEGER Icase, Iw1, Iw2, Ir, Iex1, Io1, Iscr2
    COMMON /FUNITS/ Icase, Iw1, Iw2, Ir, Iex1, Io1, Iscr2
  
    !
    EXTERNAL LENS, UPCS
    INTRINSIC CHAR, ICHAR
    !
    DATA words/'Temperature     ', 'pH              ',  &
       'Dissolved Oxygen', 'Alkalinity      ', 'Tritium         ',  &
       'H2S as S        ', 'Calcium         ', 'Eh              ',  &
       'Magnesium       ', 'Sodium          ', 'Potassium       ',  &
       'Chloride        ', 'Sulfate         ', 'Fluoride        ',  &
       'Silica          ', 'Bromide         ', 'Boron           ',  &
       'Barium          ', 'Lithium         ', 'Strontium       ',  &
       'Iron            ', 'Manganese       ', 'Nitrate         ',  &
       'Ammonium        ', 'Phosphate       ', 'DOC             ',  &
       'Sp. Cond.       ', 'Density         ', 'Delta C-13 TDIC ',  &
       'Carbon 14 TDIC  ', 'Delta S-34 (SO4)', 'Delta S-34 (H2S)',  &
       'Delta Deuterium ', 'Delta O-18      ', 'CH4 (aq)        ',  &
       'Sr 87/86        ', 'Aluminum        ', 'N2 (aq)         ',  &
       'N-15 of N2 (aq) ', 'N-15 of Nitrate ', 'N-15 of Ammonium',  &
       'Depth           ', 'Casing          ', 'Elevation       ',  &
       'RS of DOC       '/
    character*2 location(45)
    integer location_num(45)
    !!
    TYPE (VARIANT) wnSafeArray  
    TYPE (VARIANT) flagsSafeArray  
    TYPE (VARIANT) val  
    TYPE(sa_bounds), DIMENSION(2) :: ab
    INTEGER iu_dup(MAXWELLS,4)
    CHARACTER*80 wllnms_dup(MAXWELLS)
    INTEGER*4, DIMENSION(2) :: indices
    INTEGER*4 lBound
    INTEGER*4 uBound

    data location/' G', ' H', &
	    'AD', ' P', 'AO', &
	    'AE', ' J', ' I', &
	    ' K', ' L', ' M', &
	    ' N', ' O', ' T', &
	    ' U', ' V', ' W', &
	    ' X', ' Y', ' Z', &
	    ' Q', ' R', 'AA', &
	    'AB', 'AC', 'AH', &
	    'AV', 'AU', 'AJ', &
	    'AK', 'AL', 'AM', &
	    'AN', 'AP', 'AG', &
	    'AQ', ' S', 'AF', &
	    'AR', 'AS', 'AT', &
	    'BB', 'BC', 'BD', &
	    'AI'/
    data location_num/7, 8, &  !  G,  H
        30, 16, 41, &          ! AD,  P, AO
        31, 10, 9,  &          ! AE,  J,  I
        11, 12, 13, &          !  K,  L,  M
        14, 15, 20, &          !  N,  O,  T
        21, 22, 23, &          !  U,  V,  W
        24, 25, 26, &          !  X,  Y,  Z
        17, 18, 27, &          !  Q,  R, AA
        28, 29, 34, &          ! AB, AC, AH
        48, 47, 36, &          ! AV, AU, AJ
        37, 38, 39, &          ! AK, AL, AM
        40, 42, 33, &          ! AN, AP, AG
        43, 19, 32, &          ! AQ,  S, AF
        44, 45, 46, &          ! AR, AS, AT
        54, 55, 56, &          ! BB, BC, BD
        35/                    ! AI

    WRITE (*,*) 'Reading Excel ...'
 
    !! calculate range
    write(string, "(i5)") MAXWELLS + 8
    do i = 1, 4
    if (string(1:1) .eq. ' ') string = string(2:5)
    enddo
    string = "BI"//string

    !! read data 
    call set_range("A8", string)
    wnSafeArray = Range_GetValue(range)  

    n = 1
    do i = 1, MAXWELLS 
       indices(1) = i;
       
       !! save well name B, column 2, cycle if empty
        indices(2) = 2;
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_BSTR) then
            status = ConvertBSTRToString(val%VU%PTR_VAL, string)
            wllnms(n)(5:80) = string
        else
            cycle
        endif
            
        !! Well num  A, column 1
        indices(2) = 1;
        tot(n) = n
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            tot(n) = val%VU%DOUBLE_VAL
        endif  

        !! save flags  C-F, columns 3-6
        do k=3,6
            indices(2) = k;
            status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
            if (val%VT == VT_R8) then
                iu(n, k - 2) = val%VU%DOUBLE_VAL
            endif    
        enddo

        !! save data values, columns defined in location_num
        do j = 1, 45
            indices(2) = location_num(j);
            status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
            if (val%VT == VT_R8) then
                dbdata(n,j) = val%VU%DOUBLE_VAL
                dbsfg(n, j) = 0
            else
                dbdata(n,j) = 0
                dbsfg(n, j) = -1
            endif
        enddo   
        
        !! save lat/lon values
        indices(2) = 52;   ! AZ
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            write(lat(n),"(G)") val%VU%DOUBLE_VAL
        else if (val%VT == VT_BSTR) then
            status = ConvertBSTRToString(val%VU%PTR_VAL, string)
            lat(n) = string
        endif        

		!       Address
        indices(2) = 57;   ! BE
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            write(address(n, 1),"(G)") val%VU%DOUBLE_VAL
        else if (val%VT == VT_BSTR) then
            status = ConvertBSTRToString(val%VU%PTR_VAL, string)
            address(n, 1) = string
        endif
        
        indices(2) = 58;   ! BF
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            write(address(n, 2),"(G)") val%VU%DOUBLE_VAL
        else if (val%VT == VT_BSTR) then
            status = ConvertBSTRToString(val%VU%PTR_VAL, string)
            address(n, 2) = string
        endif
        
        indices(2) = 59;   ! BG
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            write(address(n, 3),"(G)") val%VU%DOUBLE_VAL
        else if (val%VT == VT_BSTR) then
            status = ConvertBSTRToString(val%VU%PTR_VAL, string)
            address(n, 3) = string
        endif
        
        indices(2) = 60;   ! BH
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            write(address(n, 4),"(G)") val%VU%DOUBLE_VAL
        else if (val%VT == VT_BSTR) then
            status = ConvertBSTRToString(val%VU%PTR_VAL, string)
            address(n, 4) = string
        endif 
        
        indices(2) = 61;   ! BI
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            write(address(n, 5),"(G)") val%VU%DOUBLE_VAL
        else if (val%VT == VT_BSTR) then
            status = ConvertBSTRToString(val%VU%PTR_VAL, string)
            address(n, 5) = string
        endif  
        n = n + 1       
    enddo
    Nwlls = n - 1
    return
END SUBROUTINE xl2db
!
!
!
SUBROUTINE XL2PHREEQC
    USE max_size
    USE ADOBJECTS
    use oleaut32
    use ifcom
    use filenames, only: root, path
    IMPLICIT NONE
    INTEGER*4 status
    character*256 string
    character*256 strings(4)
    CHARACTER*16 words(45)
    CHARACTER*1 UPCS, ans
    CHARACTER*80 line
    CHARACTER*20 frmt
    CHARACTER*10 piece
    CHARACTER*80 funame, char_linenum, cell_location
    INTEGER LENS, n, i, jcounter, k, j, kk, linenum
    !
    REAL Dbdata
    COMMON /DB    / Dbdata(MAXWELLS,45)
    INTEGER Dbsfg, Idefault, Iu, Nwlls, Totwell, Tot
    COMMON /INT4DB/ Dbsfg(MAXWELLS,45), Idefault(5), Iu(MAXWELLS,4), Nwlls,  &
       Totwell, Tot(MAXWELLS)
    CHARACTER Wllnms*80, Address*40, Lat*40, Formation*17
    COMMON /CHAR1 / Wllnms(MAXWELLS), Address(MAXWELLS,5), Lat(MAXWELLS), Formation(MAXWELLS)
    INTEGER Icase, Iw1, Iw2, Ir, Iex1, Io1, Iscr2
    COMMON /FUNITS/ Icase, Iw1, Iw2, Ir, Iex1, Io1, Iscr2
  
    !
    EXTERNAL LENS, UPCS
    INTRINSIC CHAR, ICHAR
    !
    DATA words/'Temperature     ', 'pH              ',  &
       'Dissolved Oxygen', 'Alkalinity      ', 'Tritium         ',  &
       'H2S as S        ', 'Calcium         ', 'Eh              ',  &
       'Magnesium       ', 'Sodium          ', 'Potassium       ',  &
       'Chloride        ', 'Sulfate         ', 'Fluoride        ',  &
       'Silica          ', 'Bromide         ', 'Boron           ',  &
       'Barium          ', 'Lithium         ', 'Strontium       ',  &
       'Iron            ', 'Manganese       ', 'Nitrate         ',  &
       'Ammonium        ', 'Phosphate       ', 'DOC             ',  &
       'Sp. Cond.       ', 'Density         ', 'Delta C-13 TDIC ',  &
       'Carbon 14 TDIC  ', 'Delta S-34 (SO4)', 'Delta S-34 (H2S)',  &
       'Delta Deuterium ', 'Delta O-18      ', 'CH4 (aq)        ',  &
       'Sr 87/86        ', 'Aluminum        ', 'N2 (aq)         ',  &
       'N-15 of N2 (aq) ', 'N-15 of Nitrate ', 'N-15 of Ammonium',  &
       'Depth           ', 'Casing          ', 'Elevation       ',  &
       'RS of DOC       '/
    CHARACTER*16 headings(45)
    data headings / &
	'Number', &
	'Description', &
	'Units', &
	'Redox', &
	'Temp', &
	'pH', &
	'pe', &
	'Ca', &
	'Mg', &
	'Na', &
	'K', &
	'Cl', &
	'S(6)', &
	'Alkalinity', &
	'C(4)', &
	'Fe', &
	'Mn', &
	'Al', &
	'F', &
	'Si', &
	'Br', &
	'B', &
	'Ba', &
	'Li', &
	'Sr', &
	'N(5)', &
	'N(-3)', &
	'P', &
	'O(0)', &
	'S(-2)', &
	'N(0)', &
	'C(-4)', &
	'13C', &
	'14C', &
	'34S(6)', &
	'34S(-2)', &
	'2H', &
	'3H', &
	'18O', &
	'87Sr', &
	'15N(0)', &
	'15N(5)', &
	'15N(-3)', &
	'15N(3)', &
	'Density'/
    CHARACTER*16 subheadings(45)
    data subheadings / &
	' ', &
	' ', &
	' ', &
	' ', &
	' ', &
	' ', &
	' ', &
	'as Ca', &
	'as Mg', &
	'as Na', &
	'as K', &
	'as Cl', &
	'as SO4', &
	'gfw 50.04289', &
	'gfw 50.04289', &
	'as Fe', &
	'as Mn', &
	'as Al', &
	'as F', &
	'as SiO2', &
	'as Br', &
	'as B', &
	'as Ba', &
	'as Li', &
	'as Sr', &
	'as N', &
	'as N', &
	'as P', &
	'as O', &
	'as S', &
	'as N', &
	'as CH4', &
	' ', &
	' ', &
	' ', &
	' ', &
	' ', &
	' ', &
	' ', &
	' ', &
	' ', &
	' ', &
	' ', &
	' ', &
	' '/
    TYPE (VARIANT) wnSafeArray  
    TYPE (VARIANT) flagsSafeArray  
    TYPE (VARIANT) val 
    integer fileno /10/, error_test, iunits, l
    INTEGER*4, DIMENSION(2) :: indices 
    character*1 tab
    double precision f, conv, farray(5)
    logical present(5), any_present
    
    WRITE (*,*) 'Converting Excel to PHREEQC ...'
    tab = char(9)
    !!
    string = trim(root)//".pqi"
    open (fileno,FILE=string,IOSTAT=error_test,STATUS='REPLACE')
    if (error_test .ne. 0) then
        write(*,*) "Could not open file: ", TRIM(path)//TRIM(string)
        stop 'File could not be opened'
    endif
        
 
    !! calculate range
    write(string, "(i5)") MAXWELLS + 8
    do i = 1, 4
    if (string(1:1) .eq. ' ') string = string(2:5)
    enddo
    string = "BI"//string

    !! read data 
    call set_range("A8", string)
    wnSafeArray = Range_GetValue(range)  
    
    !! write headings
    write(fileno,'("SOLUTION_SPREAD")')
    do i = 1,45
        write(fileno, '(a15,a1)', advance='NO') headings(i), tab
    enddo
    write(fileno,'(a)')
    do i = 1,45
        write(fileno, '(a15,a1)', advance='NO') subheadings(i), tab
    enddo
    write(fileno,'(a)')

    n = 1

    do i = 1, MAXWELLS 
       indices(1) = i;
       
       !! save well name B, column 2, cycle if empty
        indices(2) = 2;
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_BSTR) then
            status = ConvertBSTRToString(val%VU%PTR_VAL, string)
        else
            cycle
        endif

        !! Well num  A, column 1
        write(fileno, '(i15,a1)', advance='NO') n, tab
        
        !! Description
        do j = 1, len(string)
            if (string(j:j) .eq. "#") string(j:j) = " "
        enddo
        write(fileno, '(A,a1)', advance='NO') trim(string), tab 

        !! Units
        indices(2) = 3;
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        j = 0
        if (val%VT == VT_R8) then
            j = val%VU%DOUBLE_VAL
        endif
        iunits = j
        if (j .eq. 0) write(fileno, '(A15,a1)', advance='NO') 'mmol/kgw', tab 
        if (j .eq. 1) then
            write(*,*) 'Phreeqc does not accept units of meq/L'
            stop
        endif        
        if (j .eq. 2) write(fileno, '(A15,a1)', advance='NO') 'mg/l', tab         
        if (j .eq. 3) write(fileno, '(A15,a1)', advance='NO') 'ppm', tab        
        if (j .eq. 4) write(fileno, '(A15,a1)', advance='NO') 'mmol/kgw', tab 
        
        !! redox
        indices(2) = 4;
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        j = 0
        if (val%VT == VT_R8) then
            j = val%VU%DOUBLE_VAL
        endif
        if (j .eq. 0) write(fileno, '("pe",a1)', advance='NO') tab 
        if (j .eq. 1) write(fileno, '("pe",a1)', advance='NO') tab   
        if (j .eq. 2) write(fileno, '("O(0)/O(-2)",a1)', advance='NO') tab 
        if (j .eq. 3) write(fileno, '("O(0)/O(-2)",a1)', advance='NO') tab  
        if (j .eq. 4) write(fileno, '("S(6)/S(-2)",a1)', advance='NO') tab  
            
        !! Temp
        indices(2) = 7;
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            f = val%VU%DOUBLE_VAL
            write(fileno, '(f15.3,a1)', advance='NO') f, tab
        else
            write(fileno, '(A15,a1)', advance='NO') " ", tab
        endif
        
        !! pH
        indices(2) = 8;
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            f = val%VU%DOUBLE_VAL
            write(fileno, '(f15.3,a1)', advance='NO') f, tab
        else
            write(fileno, '(A15,a1)', advance='NO') " ", tab
        endif
        
        !! pe
        indices(2) = 9;
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            f = val%VU%DOUBLE_VAL/.059
            write(fileno, '(f15.3,a1)', advance='NO') f, tab
        else
            write(fileno, '(A15,a1)', advance='NO') " ", tab
        endif
        
        !! Ca-SO4
        do j = 10, 15
            indices(2) = j;
            status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
            if (val%VT == VT_R8) then
                f = val%VU%DOUBLE_VAL
                write(fileno, '(f15.3,a1)', advance='NO') f, tab
            else
                write(fileno, '(A15,a1)', advance='NO') " ", tab
            endif
        enddo 
        
        !! Alkalinity and TDIC
        indices(2) = 5;
        j = 0
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))         
        if (val%VT == VT_R8) then
            j = val%VU%DOUBLE_VAL       
        endif
        
        !! j is alkalinity/tdic flag
        !! iunits is units flag
        
        indices(2) = 16;
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            f = val%VU%DOUBLE_VAL
            conv = 1.0
            if (iunits .eq. 2 .or. iunits .eq. 3) then
                if (j .lt. 3) then
                    conv = 50.04289 / 61.0173
                endif
            endif
            if (j .ne. 2) then
                !! Alkalinity defined, TDIC not defined
                write(fileno, '(f15.3,a1)', advance='NO') f * conv, tab           
                write(fileno, '(A15,a1)', advance='NO') " ", tab
            else
                !! Alkalinity not defined, TDIC defined
                write(fileno, '(A15,a1)', advance='NO') " ", tab
                write(fileno, '(f15.3,a1)', advance='NO') f * conv, tab           
            endif
        else
            write(fileno, '(A15,a1)', advance='NO') " ", tab           
            write(fileno, '(A15,a1)', advance='NO') " ", tab
        endif

        !! Fe - P
        do j = 17, 29
            indices(2) = j;
            status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
            if (val%VT == VT_R8) then
                f = val%VU%DOUBLE_VAL
                write(fileno, '(f15.3,a1)', advance='NO') f, tab
            else
                write(fileno, '(A15,a1)', advance='NO') " ", tab
            endif
        enddo 
        
        !! O2, no conversion necessary for mass, factor of 2 for moles
        indices(2) = 30;
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        conv = 1.0
        if (iunits .lt. 2 .or. iunits .gt. 3) conv = 2
        if (val%VT == VT_R8) then
            f = val%VU%DOUBLE_VAL
            write(fileno, '(f15.3,a1)', advance='NO') conv*f, tab
        else
            write(fileno, '(A15,a1)', advance='NO') " ", tab
        endif      
    
        !! H2S to CH4
        do j = 31, 33
            indices(2) = j;
            status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
            if (val%VT == VT_R8) then
                f = val%VU%DOUBLE_VAL
                write(fileno, '(f15.3,a1)', advance='NO') f, tab
            else
                write(fileno, '(A15,a1)', advance='NO') " ", tab
            endif
        enddo 
        
        !!
        !! 13C & 14C
        do j = 36, 37
            indices(2) = j;
            status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
            if (val%VT == VT_R8) then
                f = val%VU%DOUBLE_VAL
                write(fileno, '(f15.3,a1)', advance='NO') f, tab
            else
                write(fileno, '(A15,a1)', advance='NO') " ", tab
            endif
        enddo 
            
        !! 34S(6) and 34S(-2)
        any_present = .FALSE.
        do j = 38,  39
            indices(2) = j;
            l = j - 37
            present(l) = .FALSE.
            status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
            if (val%VT == VT_R8) then
                farray(l) = val%VU%DOUBLE_VAL
                f = farray(l)
                present(l) = .TRUE.
                any_present = .TRUE.
            endif
        enddo 
        if (any_present .eq. .FALSE.) then
            write(fileno, '(A15,a1)', advance='NO') " ", tab
            write(fileno, '(A15,a1)', advance='NO') " ", tab
        else 
            do j = 1, 2 
                if (present(j)) then
                    write(fileno, '(f15.3,a1)', advance='NO') farray(j), tab
                else
                    write(fileno, '(f15.3,a1)', advance='NO') f, tab
                endif 
            enddo
        endif        
        
        !! 2H through 87Sr
        do j = 40, 43
            indices(2) = j;
            status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
            if (val%VT == VT_R8) then
                f = val%VU%DOUBLE_VAL
                write(fileno, '(f15.3,a1)', advance='NO') f, tab
            else
                write(fileno, '(A15,a1)', advance='NO') " ", tab
            endif
        enddo 

        !! 15N for N(0), N(5), N(-3), N(3)
        any_present = .FALSE.
        present(4) = .FALSE.
        do j = 44, 46
            indices(2) = j;
            l = j - 43
            present(l) = .FALSE.
            status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
            if (val%VT == VT_R8) then
                farray(l) = val%VU%DOUBLE_VAL
                f = farray(l)
                present(l) = .TRUE.
                any_present = .TRUE.
            endif
        enddo 
        if (any_present .eq. .FALSE.) then
            write(fileno, '(A15,a1)', advance='NO') " ", tab
            write(fileno, '(A15,a1)', advance='NO') " ", tab
            write(fileno, '(A15,a1)', advance='NO') " ", tab
            write(fileno, '(A15,a1)', advance='NO') " ", tab
        else 
            do j = 1, 4 
                if (present(j)) then
                    write(fileno, '(f15.3,a1)', advance='NO') farray(j), tab
                else
                    write(fileno, '(f15.3,a1)', advance='NO') f, tab
                endif 
            enddo
        endif  
        
        !! Density
        indices(2) = 47;
        status = SafeArrayGetElement(wnSafeArray%VU%PTR_VAL, indices(1), LOC(val))
        if (val%VT == VT_R8) then
            f = val%VU%DOUBLE_VAL
            write(fileno, '(f15.3,a1)', advance='NO') f, tab
        else
            write(fileno, '(A15,a1)', advance='NO') " ", tab
        endif
        
        !! End of line
        write(fileno,'(a)')      
   
        !! increment n
        n = n + 1       
    enddo
    close(fileno)
    
    return
END SUBROUTINE xl2phreeqc
!
!
!
subroutine doCreate(string)

	  USE IFWIN
	  USE ADOBJECTS

character*(*) string

type (T_OPENFILENAME)       of
character*256               buffer
character*256               buffer1
character*56                buffer2
character*56                buffer3
character*56                buffer4
character*256               szFileTitle

type (T_STARTUPINFO)            sui
type (T_PROCESS_INFORMATION)    pi

integer*4           ret

logical(4)          bret
integer*4           l

szFileTitle = ""C
buffer = szFileTitle



!    /* set up the STARTUPINFO structure,
!     *  then call CreateProcess to try and start the new exe.
!     */
sui%cb             = 68 ! SIZESTARTUPINFO  ! 68 ( sizeof(StartUpInfo)
sui%lpReserved       = 0
sui%lpDesktop        = NULL
sui%lpTitle          = NULL
sui%dwX              = 0
sui%dwY              = 0
sui%dwXSize          = 0
sui%dwYSize          = 0
sui%dwXCountChars    = 0
sui%dwYCountChars    = 0
sui%dwFillAttribute  = 0
sui%dwFlags          = 0
sui%wShowWindow      = 0
sui%cbReserved2      = 0
sui%lpReserved2      = 0

buffer = string
buffer(lens(buffer) + 1: lens(buffer) + 2) = szFileTitle(1:2)
l = 0
bret = CreateProcess (                              &
					 NULL_CHARACTER,                &
					 buffer,        &
					 NULL_SECURITY_ATTRIBUTES,      &
					 NULL_SECURITY_ATTRIBUTES,      &
					 l,                       &
					 DETACHED_PROCESS,              &
					 NULL,                          &
					 NULL_CHARACTER,                &
					 sui, &
					 pi)

return

end
Subroutine NewExcelA0(c13_meas, c14_meas, &
    c13_solid, c14_solid, &
    c13_uz, c14_uz, &
    a0_models, well_name)
    USE filenames
    USE max_size
    USE IFQWIN
    USE IFCOM
    USE ADOBJECTS
    USE excel_headings

    IMPLICIT NONE   
    integer lens
    external lens  
    double precision c13_meas, c14_meas, c13_solid, c14_solid, c13_uz, c14_uz
    double precision a0_models(*)
    character*(*) well_name
    character*20 str, rng
    double precision top, left, bottom, right
    
    ! common blocks
    INTEGER Wunit, Nwlls, Icase, Jele, Nodata, Isdocrs
    COMMON /INT1  / Wunit, Nwlls, Icase, Jele(39,36), Nodata(MAXWELLS,50), &
        Isdocrs(0:5)
    INTEGER Well, Tunit, Iflag, Inum, Nrun
    COMMON /INT4  / Well(0:5), Tunit, Iflag(6), Inum, Nrun
    CHARACTER Wllnms*80, Transfer*1, Model*20, Yes*3, Ion*10, Ffact*14
    COMMON /CHAR4 / Wllnms(0:MAXWELLS), Transfer(39), Model(N_C14_MODELS), Yes(0:1), &
        Ion(4), Ffact(0:1) 
    DOUBLE PRECISION C14dat, Dbdata, P, Delta, Disalong, Usera
    COMMON /DP4   / C14dat(13), Dbdata(0:MAXWELLS,0:50), P(3), Delta(40), &
        Disalong, Usera(5)  
    DOUBLE PRECISION Clmain, Cleach, Pdat, Res, Sfinal, Sinit, Maxdel,  &
        Mindel, Dfinal
    COMMON /DP3   / Clmain(202,40), Cleach(202,40), Pdat(40,40),  &
        Res(100), Sfinal(39), Sinit(5,59), Maxdel(39),  &
        Mindel(39), Dfinal
  
    ! Variables
    INTEGER*4 status
    TYPE (VARIANT) :: template
    INTEGER*4 loopCount
    INTEGER*4 die1
    INTEGER*4 die2
    INTEGER*4 roll
    INTEGER*4 maxScale
    CHARACTER (LEN = 32) :: loopc
    INTEGER*4   i, j
    LOGICAL*2 l
    REAL*4    rnd
    INTEGER*2, DIMENSION(1:12) :: cellCounts
    integer*4 excelapp1
    integer*4 series_collection, series, series_format, ptr_return
    integer*4 chart_format, line_format, color_format
    integer*4 axis, chart_area, shapes, shape_range
    integer*4 fill, font, interior
    character*10 cell_location
    logical*2 l2

    ! Variant arguments
    TYPE (VARIANT) :: vBSTR1
    TYPE (VARIANT) :: vBSTR2
    TYPE (VARIANT) :: vBSTR3
    TYPE (VARIANT) :: vBSTR4
    TYPE (VARIANT) :: vBSTR5

    TYPE (VARIANT) :: vInt
    real max_x, max_y, data_x, data_y

    ! set max for graph
    max_x = 10
    max_y = 100
    data_x = -100
    data_y = -100
    do i = 1, Nwlls
        if (DBDATA(i,41) .ne. 0) then
            if (DBDATA(i,21)/DBDATA(i,41) > data_x) then
                data_x = DBDATA(i,21)/DBDATA(i,41)
            endif                  
            if (DBDATA(i,22)/DBDATA(i,41) > data_y) then
                data_y = DBDATA(i,21)/DBDATA(i,41)
            endif
        endif 
    enddo    
    do while (data_x > max_x) 
        max_x = max_x + 10.
    enddo 
    do while (data_y > max_y) 
        max_y = max_y + 10.
    enddo     

    ! Create an Excel object
    CALL COMCreateObjectByProgID("Excel.Application", excelappA0, status)
    IF (excelappA0 == 0) THEN
        WRITE (*, '(" Unable to create Excel object; Aborting")')
        CALL EXIT()
    END IF
    l = .TRUE.
    CALL $Application_SetVisible(excelappA0, l)
    CALL $Application_SetWidth(excelappA0, dble(900.), status)
    CALL $Application_SetHeight(excelappA0, dble(650.), status)

    ! Get the WORKBOOKS object
    workbooksA0 = $Application_GetWorkbooks(excelappA0, status)
    CALL Check_Status(status, " Unable to get WORKBOOKS object")

    ! Open the specified spreadsheet file (note: specify the full file path)
    workbookA0 = Workbooks_Add(workbooksA0,$STATUS = status )
    CALL Check_Status(status, " Unable to get WORKBOOK object; ensure that the file path is correct")

    ! Get the worksheet
    worksheetA0 = $Workbook_GetActiveSheet(workbookA0, status)
    CALL Check_Status(status, " Unable to get WORKSHEET object")

    ! set width for A, MODEL NUMBER
    call set_rangeA0('a1','a1')
    call set_column_width(16.0)

    ! set width for B, A0 Model
    call set_rangeA0('b1','b1')
    call set_column_width(26.0)
    
    ! set width for C, 13C, permil
    call set_rangeA0('c1','c1')
    call set_column_width(10.5) 
    
    ! set width for C, 13C, permil
    call set_rangeA0('p1','p1')
    call set_column_width(20.0)   

    ! set decimal 
    call set_rangeA0('c3','p3')
    call set_decimal_places('0.00')
    
    call set_rangeA0('c3','c600')
    call set_decimal_places('0.00')   

    call set_rangeA0('d3','d600')
    call set_decimal_places('0.0')  

    call set_rangeA0('e10','e12')
    call set_decimal_places('0')

    call set_rangeA0('q3','q50')
    call set_decimal_places('0.00')

    call set_rangeA0('r5','r50')
    call set_decimal_places('0.0') 
    
    call set_rangeA0('q19','q25')
    call set_decimal_places('0.00000') 
    
    call set_rangeA0('c20','e22')
    call set_decimal_places('0.0') 

    ! Title
    CALL setcell_characterA0('a1','Revised Fontes and Garnier (Han and Plummer, 2013)*') 
    CALL set_rangeA0('a1','a1')
    !CALL VariantInit(vInt)
    !vInt%VT = VT_R4
    !vBSTR1%VU%FLOAT_VAL = 40.
    !call Range_SetRowHeight(rangeA0, vInt, status)
    !CALL Check_Status(status, " Unable to set RowHeight")
    
    font = Range_GetFont(rangeA0, status)
    vInt%VT = VT_I4
    vInt%VU%LONG_VAL = msoTrue   
    call Font_SetBold(font, vInt, status)
    vInt%VU%LONG_VAL = 14  
    call Font_SetSize(font, vInt, status)
    
    ! Calculated values
    CALL setcell_characterA0('p1','                                          Calculated Values') 
    
    ! Set header character strings
    CALL setcell_characterA0('b2','Well name') 
    CALL setcell_characterA0('c2','13C, permil')
    CALL setcell_characterA0('d2','14C, pmc')  
    CALL setcell_characterA0('e2','H2CO3')
    CALL setcell_characterA0('f2','HCO3')
    CALL setcell_characterA0('g2','CO3')
    CALL setcell_characterA0('h2','TempC')
    CALL setcell_characterA0('i2','CH4')
    CALL setcell_characterA0('j2','13C CH4')
    CALL setcell_characterA0('k2','14C CH4')
    CALL setcell_characterA0('l2','DOC')
    CALL setcell_characterA0('m2','13C DOC')
    CALL setcell_characterA0('n2','14C DOC')
    !CALL setcell_characterA0('o2','1/HCO3')  
    CALL setcell_characterA0('q2','TDIC')
    CALL setcell_characterA0('r2','Total C')
    
    ! Measured, line 3
    CALL setcell_characterA0('b3',well_name)
    CALL setcell_floatA0('c3',real(c13_meas),2)
    CALL setcell_floatA0('d3',real(c14_meas),2)
    CALL setcell_floatA0('e3',real(Dbdata(Well(1),38)),2)
    CALL setcell_floatA0('f3',real(Dbdata(Well(1),36)),2)
    CALL setcell_floatA0('g3',real(Dbdata(Well(1),39)),2)
    CALL setcell_floatA0('h3',real(Dbdata(Well(1),50)),2)
    if (Dbdata(Well(1),42) .gt. 0) then
        CALL setcell_floatA0('i3',real(Dbdata(Well(1),42)),2)
    endif
    CALL setcell_floatA0('j3',real(Dbdata(Well(1),44)),2)
    CALL setcell_floatA0('k3',real(Dbdata(Well(1),46)),2)
    if (Dbdata(Well(1),43) .gt. 0) then    
        CALL setcell_floatA0('l3',real(Dbdata(Well(1),43)),2)
    endif
    CALL setcell_floatA0('m3',real(Dbdata(Well(1),45)),2)
    CALL setcell_floatA0('n3',real(Dbdata(Well(1),47)),2)        
    !if (Dbdata(Well(1),36) .gt. 0.0) then 
    !    CALL setcell_floatA0('o3',real(1.0/Dbdata(Well(1),36)),2)   
    !endif
    ! Calculate tdic and total c   
    CALL set_rangeA0('q3','q3')
    !call set_formula('=E3+F3+G3') 
    call set_formula('=R3C5+R3C6+R3C7') 
    CALL set_rangeA0('r3','r3')
    !call set_formula('=E3+F3+G3+I3+L3')  
    call set_formula('=R3C5+R3C6+R3C7+R3C9+R3C12')  
    
    ! Isotopic values
    CALL setcell_characterA0('b5','Carbonate solid')
    CALL setcell_floatA0('c5',real(c13_solid),2)
    CALL setcell_floatA0('d5',real(c14_solid),2)
    CALL setcell_characterA0('b6','UZ gas')
    CALL setcell_floatA0('c6',real(c13_uz),2)
    CALL setcell_floatA0('d6',real(c14_uz),2)
    ! Uncertainty in X (13C)
    CALL setcell_characterA0('b7','Uncertainty')
    CALL setcell_floatA0('c7',2.0,2) 
    CALL setcell_floatA0('d7',5.0,2) 
    
    ! Calculate origin
    CALL setcell_characterA0('p5','Tamers point')    
    CALL set_rangeA0('q5','q5')
    !call set_formula('=(C5+C6)/2') 
    call set_formula('=(R5C3+R6C3)/2')   
    CALL set_rangeA0('r5','r5')
    !call set_formula('=(D5+D6)/2') 
    call set_formula('=(R5C4+R6C4)/2') 
    
    ! Calculate tk
    CALL setcell_characterA0('p6','TempK')    
    CALL set_rangeA0('q6','q6')
    !call set_formula('=H3+273.15')
    call set_formula('=R3C8+273.15')

    ! Origin X, x values
    CALL setcell_characterA0('p8','Tamers X')
    CALL set_rangeA0('q8','q8')
    call set_formula('=R[-3]C[0]')
    CALL set_rangeA0('q9','q9')
    call set_formula('=R[-4]C[0]')
        ! Origin X, y values
    CALL setcell_floatA0('r8',0.0,2)
    CALL setcell_floatA0('r9',max_y,2)     
    
    ! Origin Y, x values
    CALL setcell_characterA0('p10','Tamers Y')
    CALL setcell_floatA0('q10',-30.,2)
    CALL setcell_floatA0('q11',max_x,2)
        ! Origin Y, y values
    CALL set_rangeA0('r10','r10')
    call set_formula('=R[-5]C[0]')
    CALL set_rangeA0('r11','r11')
    call set_formula('=R[-6]C[0]')

    ! Tamers lines
        ! right
    CALL setcell_characterA0('p12','Tamers area')
    CALL set_rangeA0('q12','q12')
    call set_formula('=R[-7]C[0] + R7C3')
    CALL setcell_floatA0('r12',0.,2)
    
    CALL set_rangeA0('q13','q13')
    call set_formula('=R[-1]C[0]')
    CALL set_rangeA0('r13','r13')
    call set_formula('=R[-8]C[0] + R7C4')

        ! left
    CALL set_rangeA0('q14','q14')
    call set_formula('=R[-9]C[0] - R7C3')
    CALL set_rangeA0('r14','r14')
    call set_formula('=R[-1]C[0]')
    
    CALL set_rangeA0('q15','q15')
    call set_formula('=R[-1]C[0]')
    CALL setcell_floatA0('r15',0.0,2)
    
    ! Fractionation
    !CALL setcell_characterA0('C11','Alpha') 
    !CALL setcell_characterA0('D11','Epsilon') 
    !CALL setcell_characterA0('B12','CO2(aq)-HCO3')
    !CALL set_rangeA0('c12','c12')
    !call set_formula('=(24.12-9866/C10)/1000+1') 
    !CALL set_rangeA0('d12','d12')
    !call set_formula('=(C12-1)*1000')  
    !CALL setcell_characterA0('B13','CO3-HCO3')  
    !CALL set_rangeA0('c13','c13')
    !call set_formula('=(2.52-867/C10)/1000+1') 
    !CALL set_rangeA0('d13','d13')
    !call set_formula('=(C13-1)*1000') 
    !CALL setcell_characterA0('B14','Calcite-HCO3')    
    !CALL set_rangeA0('c14','c14')
    !call set_formula('=(15.1-4232/C10)/1000+1') 
    !CALL set_rangeA0('d14','d14')
    !call set_formula('=(C14-1)*1000')
    !CALL setcell_characterA0('B15','CO2(g)-HCO3') 
    !CALL set_rangeA0('c15','c15')
    !call set_formula('=(23.89-9483/C10)/1000+1') 
    !CALL set_rangeA0('d15','d15')
    !call set_formula('=(C15-1)*1000') 
    !CALL setcell_characterA0('B16','CO2(aq)-CO2(g)') 
    !CALL set_rangeA0('c16','c16')
    !call set_formula('=(0.19-373/C10)/1000+1') 
    !CALL set_rangeA0('d16','d16')
    !call set_formula('=(C16-1)*1000')  
    !CALL setcell_characterA0('B17','CO2(g)-solution') 
    !CALL set_rangeA0('c17','c17')
    !call set_formula('=C15*O3/(C12*E3+F3+C13*G3)') 
    !CALL set_rangeA0('d17','d17')
    !call set_formula('=(C17-1)*1000')   
    CALL setcell_characterA0('p18','Mook') 
    CALL setcell_characterA0('q18','Alpha') 
    CALL setcell_characterA0('r18','Epsilon') 
    CALL setcell_characterA0('p19','CO2(aq)-HCO3')
    CALL set_rangeA0('q19','q19')
    call set_formula('=(24.12-9866/R6C17)/1000+1') 
    CALL set_rangeA0('r19','r19')
    call set_formula('=(R[0]C[-1]-1)*1000')  
    CALL setcell_characterA0('p20','CO3-HCO3')  
    CALL set_rangeA0('q20','q20')
    call set_formula('=(2.52-867/R6C17)/1000+1') 
    CALL set_rangeA0('r20','r20')
    call set_formula('=(R[0]C[-1]-1)*1000') 
    CALL setcell_characterA0('p21','Calcite-HCO3')    
    CALL set_rangeA0('q21','q21')
    call set_formula('=(15.1-4232/R6C17)/1000+1') 
    CALL set_rangeA0('r21','r21')
    call set_formula('=(R[0]C[-1]-1)*1000')
    CALL setcell_characterA0('p22','CO2(g)-HCO3') 
    CALL set_rangeA0('q22','q22')
    call set_formula('=(23.89-9483/R6C17)/1000+1') 
    CALL set_rangeA0('r22','r22')
    call set_formula('=(R[0]C[-1]-1)*1000') 
    CALL setcell_characterA0('p23','CO2(g)-CO2(aq)') 
    CALL set_rangeA0('q23','q23')
    call set_formula('=1.0/((0.19-373/R6C17)/1000+1)') 
    CALL set_rangeA0('r23','r23')
    call set_formula('=(R[0]C[-1]-1)*1000')  
    CALL setcell_characterA0('p24','CO2(g)-solution') 
    CALL set_rangeA0('q24','q24')
    !call set_formula('=C15*O3/(C12*E3+F3+C13*G3)') 
    call set_formula('=R[-2]C[0]*R3C17/(R[-5]C[0]*R3C5+R3C6+R[-4]C[0]*R3C7)') 
    CALL set_rangeA0('r24','r24')
    call set_formula('=(R[0]C[-1]-1)*1000')   
    CALL setcell_characterA0('p25','Calcite-solution') 
    CALL set_rangeA0('q25','q25')
    call set_formula('=R[-4]C[0]*R3C17/(R[-6]C[0]*R3C5+R3C6+R[-5]C[0]*R3C7)') 
    CALL set_rangeA0('r25','r25')
    call set_formula('=(R[0]C[-1]-1)*1000')       
    
    ! Shade calculated values
    CALL set_rangeA0('q2','r31')
    call set_fill(10092543)
    CALL set_rangeA0('d10','e12')
    call set_fill(10092543)
    CALL set_rangeA0('c11','c12')
    call set_fill(10092543)
    CALL set_rangeA0('k1','k1')
    call set_fill(10092543)
    CALL setcell_characterA0('L1','Output shaded yellow')
    ! Shade input values
    !CALL set_rangeA0('c3','o3')
    CALL set_rangeA0('c3','n3')
    call set_fill(16772300)
    CALL set_rangeA0('c5','d7')
    call set_fill(16772300)
    CALL set_rangeA0('g1','g1')
    call set_fill(16772300)
    CALL setcell_characterA0('h1','Input shaded blue')
    

    ! More lines
        ! Zero age line
    CALL setcell_characterA0('p27','Zero-age line')
    CALL set_rangeA0('q27','q27')
    call set_formula('=R5C3')
    CALL set_rangeA0('r27','r27')
    call set_formula('=R5C4')
    CALL set_rangeA0('q28','q28')
    call set_formula('=R5C17')
    CALL set_rangeA0('r28','r28')
    call set_formula('=R5C18')
    
        ! Mook line
    CALL setcell_characterA0('p30','Zero-age line (Mook)')
    CALL set_rangeA0('q30','q30')
    call set_formula('=R28C17')
    CALL set_rangeA0('r30','r30')
    call set_formula('=R28C18')
    CALL set_rangeA0('q31','q31')
    call set_formula('=R6C3-R24C18')
    CALL set_rangeA0('r31','r31')
    call set_formula('=R6C4')

    ! A0 Models
    CALL setcell_characterA0('a9','MODEL NUMBER')
    CALL setcell_characterA0('b9','A0 model')
    CALL setcell_characterA0('c9','FG K')
    CALL setcell_characterA0('d9','A0, pmc')
    CALL setcell_characterA0('e9','Age, yr')

    !! Tamers
    !CALL setcell_characterA0('a20','4')
    !CALL setcell_characterA0('b20','Tamers')
    !CALL set_rangeA0('d20','d20')
    !call set_formula('=((((E3+0.5*F3)*D6+D5 *0.5*F3)/(E3+F3)) *O3+I3*J3+L3 *M3)/O3') 
    !CALL setcell_characterA0('f20','Use Tamers (model 4) if measured is between vertical lines')
    !
    !! Revised F&G gas exchange
    !CALL setcell_characterA0('a21','10')
    !CALL setcell_characterA0('b21','Revised F&G, Gas exchange')
    !CALL set_rangeA0('d21','d21')
    !call set_formula('=(E3/O3*(D6+0.2*D16)+F3/O3*0.5*(D6+0.2*D16 + D5))+E21')
    !CALL set_rangeA0('e21','e21')
    !call set_formula('=(D6-0.5*(D6+0.2*D16+D5)-0.2*D15)*(C3-E3/O3*(C6+D16)-F3/O3*0.5*(C6+D16+C5))/(C6-0.5*(C6+D16+C5)-D15)')
    !CALL setcell_characterA0('f21','Use gas exchange (model 10) if measured is left of vertical lines')
    !
    !! Revised F&G solid exchange
    !CALL setcell_characterA0('a22','11')
    !CALL setcell_characterA0('b22','Revised F&G, Solid exchange')
    !CALL set_rangeA0('d22','d22')
    !call set_formula('=(E3/O3*(D6+0.2*D16)+F3/O3*0.5*(D6+0.2*D16 + D5))+E22')
    !CALL set_rangeA0('e22','e22')
    !call set_formula('=(D5-0.5*(D6+0.2*D16+D5)-0.2*D14)*(C3-E3/O3*(C6+D16)-F3/O3*0.5*(C6+D16+C5))/(C5-0.5*(C6+D16+C5)-D14)')
    !CALL setcell_characterA0('f12','Use solid exchange (model 11) if measured is right of vertical lines')

    ! Tamers
    CALL setcell_characterA0('a10','4')
    CALL setcell_characterA0('b10','Tamers')
    CALL set_rangeA0('d10','d10')
    !call set_formula('=((((E3+0.5*F3)*D6+D5 *0.5*F3)/(E3+F3)) *O3+I3*J3+L3 *M3)/O3') 
    ! =((((E3+0.5*F3)*D6+D5 *0.5*F3)/(E3+F3)) *O3+I3*J3+L3 *M3)/O3
    call set_formula('=((((R3C5+0.5*R3C6)*R6C4+R5C4 *0.5*R3C6)/(R3C5+R3C6))*R3C17+R3C9*R3C10+R3C12*R3C13)/R3C18') 
    CALL set_rangeA0('e10','e10')
    !CALL set_formula('=IF(R10C4 > 0, 5730/LN(2)*LN(R10C4/R3C4), 0)')
    ! replace d3 with (d3*q3 + i3*k3 + l3*n3)/r3
    ! ((R3C4*R3C17 + R3C9*R3C11 + R3C12*R3C14)/R3C18)
    CALL set_formula('=IF(R10C4 > 0, 5730/LN(2)*LN(R10C4/((R3C4*R3C17 + R3C9*R3C11 + R3C12*R3C14)/R3C18)), 0)')
    
    ! Revised F&G gas exchange
    CALL setcell_characterA0('a11','10')
    CALL setcell_characterA0('b11','Revised F&G, Gas exchange')
    CALL set_rangeA0('c11','c11')
    call set_formula('=(R6C4-0.5*(R6C4+0.2*R23C18+R5C4)-0.2*R22C18)*(R3C3-R3C5/R3C17*(R6C3+R23C18)-R3C6/R3C17*0.5*(R6C3+R23C18+R5C3))/(R6C3-0.5*(R6C3+R23C18+R5C3)-R22C18)')
    CALL set_rangeA0('d11','d11')
    call set_formula('=(((R3C5/R3C17*(R6C4+0.2*R23C18)+R3C6/R3C17*0.5*(R6C4+0.2*R23C18 + R5C4))+R11C3)*R3C17+R3C9*R3C10+R3C12*R3C13)/R3C18')
    CALL set_rangeA0('e11','e11')
    CALL set_formula('=IF(R11C4 > 0, 5730/LN(2)*LN(R11C4/((R3C4*R3C17 + R3C9*R3C11 + R3C12*R3C14)/R3C18)), 0)')
    
    ! Revised F&G solid exchange
    CALL setcell_characterA0('a12','11')
    CALL setcell_characterA0('b12','Revised F&G, Solid exchange')
    CALL set_rangeA0('c12','c12')
    call set_formula('=(R5C4-0.5*(R6C4+0.2*R23C18+R5C4)-0.2*R21C18)*(R3C3-R3C5/R3C17*(R6C3+R23C18)-R3C6/R3C17*0.5*(R6C3+R23C18+R5C3))/(R5C3-0.5*(R6C3+R23C18+R5C3)-R21C18)')
    CALL set_rangeA0('d12','d12')
    call set_formula('=(((R3C5/R3C17*(R6C4+0.2*R23C18)+R3C6/R3C17*0.5*(R6C4+0.2*R23C18 + R5C4))+R12C3)*R3C17+R3C9*R3C10+R3C12*R3C13)/R3C18') 
    CALL set_rangeA0('e12','e12')
    ! 5730.0D0/DLOG(2.D0)*DLOG(dResult/Dfinal)
    CALL set_formula('=IF(R12C4 > 0, 5730/LN(2)*LN(R12C4/((R3C4*R3C17 + R3C9*R3C11 + R3C12*R3C14)/R3C18)), 0)')

    ! Comments
    CALL setcell_characterA0('g21','In applying the Revised Fontes & Garnier model of Han and Plummer (2013): ')  
        ! bold
    CALL set_rangeA0('g21','g21')
    font = Range_GetFont(rangeA0, status)
    vInt%VT = VT_I4
    vInt%VU%LONG_VAL = msoTrue   
    call Font_SetBold(font, vInt, status)
    CALL setcell_characterA0('g22','Use Tamers (model 4) if measured is inside area of blue lines')
    CALL setcell_characterA0('g23','Use gas exchange (model 10) if measured is left of vertical blue lines')
    CALL setcell_characterA0('g24','Use solid exchange (model 11) if measured is right of verical blue lines') 
    
    ! Notes
    CALL setcell_characterA0('a14','Note: If the initial water and final water are defined separately, the adjustment ')
    CALL setcell_characterA0('a15','model will be applied to the initial water.  The modeled A0 value will then be')
    CALL setcell_characterA0('a16','adjusted using the geochemical model found in evolving the initial water to the')
    CALL setcell_characterA0('a17','final water. If the adjustment model is to be applied to a single water sample,')
    CALL setcell_characterA0('a18','that sample should be selected as both the initial and final water sample.')
    
    ! Refs
    CALL setcell_characterA0('a20','* Han, L.-F. and Plummer, L.N., 2013, Revision of Fontes & Garnier''s model for ')
    CALL setcell_characterA0('a21','the initial 14C content of dissolved inorganic carbon used in groundwater')
    CALL setcell_characterA0('a22','dating.  Chemical Geology 351 (2013) 105-114.')
    CALL setcell_characterA0('a24','See also: Han, L.-F., Plummer, L.N., and Aggarwal, P., 2012, A graphical method')
    CALL setcell_characterA0('a25','to evaluate predominant geochemical processes occurring ingroundwater')
    CALL setcell_characterA0('a26','systems for radiocarbon dating. Chemical Geology 318-319, 88-112.')
    
    ! Put all 13C, 14C data in spreadsheet for plot
    CALL setcell_characterA0('B28','Well name')
    CALL setcell_characterA0('b28','Well name') 
    CALL setcell_characterA0('c28','13C, permil')
    CALL setcell_characterA0('d28','14C, pmc')  
    CALL setcell_characterA0('e28','H2CO3')
    CALL setcell_characterA0('f28','HCO3')
    CALL setcell_characterA0('g28','CO3')
    CALL setcell_characterA0('h28','TempC')
    CALL setcell_characterA0('i28','CH4')
    CALL setcell_characterA0('j28','13C CH4')
    CALL setcell_characterA0('k28','14C CH4')
    CALL setcell_characterA0('l28','DOC')
    CALL setcell_characterA0('m28','13C DOC')
    CALL setcell_characterA0('n28','14C DOC') 
    !CALL setcell_characterA0('o28','1/HCO3')    
    do i = 1, Nwlls
        write(str,'(I3)') i+28
        call left_trim(str)
        rng = 'B' // str
        call setcell_characterA0(rng(1:lens(rng)), Wllnms(i))
        if (DBDATA(i,41) .ne. 0) then
            rng = 'C' // str
            CALL setcell_floatA0(rng(1:lens(rng)), real(DBDATA(i,21)/DBDATA(i,41)), 2)
            rng = 'D' // str
            CALL setcell_floatA0(rng(1:lens(rng)), real(DBDATA(i,22)/DBDATA(i,41)), 2)     
        endif 
        rng = 'E' // str   
        CALL setcell_floatA0(rng(1:lens(rng)),real(Dbdata(i,38)),2)
        rng = 'F' // str   
        CALL setcell_floatA0(rng(1:lens(rng)),real(Dbdata(i,36)),2)
        rng = 'G' // str   
        CALL setcell_floatA0(rng(1:lens(rng)),real(Dbdata(i,39)),2)
        rng = 'H' // str   
        CALL setcell_floatA0(rng(1:lens(rng)),real(Dbdata(i,50)),2)
        rng = 'I' // str   
        if (Dbdata(Well(1),42) .gt. 0) then  
            CALL setcell_floatA0(rng(1:lens(rng)),real(Dbdata(i,42)),2)
        endif
        rng = 'J' // str   
        CALL setcell_floatA0(rng(1:lens(rng)),real(Dbdata(i,44)),2)
        rng = 'K' // str   
        CALL setcell_floatA0(rng(1:lens(rng)),real(Dbdata(i,46)),2)
        rng = 'L' // str   
        if (Dbdata(Well(1),43) .gt. 0) then      
            CALL setcell_floatA0(rng(1:lens(rng)),real(Dbdata(i,43)),2)
        endif
        rng = 'M' // str   
        CALL setcell_floatA0(rng(1:lens(rng)),real(Dbdata(i,45)),2)
        rng = 'N' // str   
        CALL setcell_floatA0(rng(1:lens(rng)),real(Dbdata(i,47)),2)   
        !if (Dbdata(i,36) .gt. 0.0) then 
        !    rng = 'O' // str   
        !    CALL setcell_floatA0(rng(1:lens(rng)),real(1.0/Dbdata(i,36)),2)   
        !endif
    enddo
    
    ! Generate plot
    chartsA0 = $Workbook_GetCharts(workbookA0, $STATUS = status)
    CALL Check_Status(status, " Unable to get CHARTS object")
    chartA0 = Charts_Add(chartsA0, $STATUS = status)
    CALL Check_Status(status, " Unable to add CHART object")

    ! plot type
    CALL VariantInit(vInt)
    vInt%VT = VT_I4
    vInt%VU%LONG_VAL = xlXYScatterLinesNoMarkers
    ! title
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR("Han and Plummer Plot")
    vBSTR1%VU%PTR_VAL = bstr1
    ! X axis
    CALL VariantInit(vBSTR2)
    vBSTR2%VT = VT_BSTR
    bstr2 = ConvertStringToBSTR("Carbon-13, permil")
    vBSTR2%VU%PTR_VAL = bstr2
    ! Y axis
    CALL VariantInit(vBSTR3)
    vBSTR3%VT = VT_BSTR
    bstr3 = ConvertStringToBSTR("Carbon-14, pmc")
    vBSTR3%VU%PTR_VAL = bstr3
    ! Chart wizard
    CALL $Chart_ChartWizard(chartA0, &
        Gallery = vInt, &
        Title = vBSTR1, &
        CategoryTitle = vBSTR2, &
        ValueTitle = vBSTR3, &
        $STATUS = status)
    CALL Check_Status(status, " Unable to invoke ChartWizard")
    status = VariantClear(vBSTR1)
    bstr1 = 0
    status = VariantClear(vBSTR2)
    bstr2 = 0
    status = VariantClear(vBSTR3)
    bstr3 = 0
    
    ! set X bounds
    CALL VariantInit(vInt)
    vInt%VT = VT_I4
    vInt%VU%LONG_VAL = xlCategory
    axis = $Chart_Axes(chartA0, vInt, xlPrimary, status)
    CALL Check_Status(status, " Unable to get axes")
    call Axis_SetMinimumScale(axis, dble(-30), status)
    CALL Check_Status(status, " Unable to set MinimumScale")
    call Axis_SetMaximumScale(axis, dble(max_x), status)
    CALL Check_Status(status, " Unable to set MaximumScale")
    call Axis_SetMajorUnit(axis, dble(10), status)
    CALL Check_Status(status, " Unable to set MajorUnit")
    call Axis_SetMinorUnit(axis, dble(2), status)
    CALL Check_Status(status, " Unable to set MinorUnit")
    call Axis_SetCrossesAt(axis, dble(-30), status)
    CALL Check_Status(status, " Unable to set CrossesAt")
    call Axis_SetMajorTickMark(axis, xlInside, status)
    CALL Check_Status(status, " Unable to set MajorTickMark")
    call Axis_SetMinorTickMark(axis, xlInside, status)
    CALL Check_Status(status, " Unable to set MinorTickMark")
    ! Turn off gridlines
    call Axis_SetHasMajorGridlines(axis, .false., status)
    CALL Check_Status(status, " Unable to set SetHasMajorGridlines")
    
     ! set Y bounds
    CALL VariantInit(vInt)
    vInt%VT = VT_I4
    vInt%VU%LONG_VAL = xlValue
    axis = $Chart_Axes(chartA0, vInt, xlPrimary, status)
    CALL Check_Status(status, " Unable to get axes")
    call Axis_SetMinimumScale(axis, dble(0), status)
    CALL Check_Status(status, " Unable to set MinimumScale")
    call Axis_SetMaximumScale(axis, dble(max_y), status)
    CALL Check_Status(status, " Unable to set MaximumScale")
    call Axis_SetMajorUnit(axis, dble(10), status)
    CALL Check_Status(status, " Unable to set MajorUnit")
    call Axis_SetMinorUnit(axis, dble(5), status) 
    CALL Check_Status(status, " Unable to set MinorUnit")  
    call Axis_SetMajorTickMark(axis, xlInside, status)
    CALL Check_Status(status, " Unable to set MajorTickMark")
    call Axis_SetMinorTickMark(axis, xlInside, status)
    CALL Check_Status(status, " Unable to set MinorTickMark")
    ! Turn off gridlines
    call Axis_SetHasMajorGridlines(axis, .false., status)
    CALL Check_Status(status, " Unable to set SetHasMajorGridlines")
    
    ! Delete series
    CALL VariantInit(vInt)
    vInt%VT = VT_I4
    vInt%VU%LONG_VAL = 1
    series_collection = $Chart_SeriesCollection(chartA0)
    series = SeriesCollection_Item(series_collection, vInt, status)
    CALL Check_Status(status, " Unable to find default series")
    vInt = Series_Delete(series, status)
    CALL Check_Status(status, " Unable to delete default series")
    
    ! Add series  X origin
    call add_line("=Sheet1!$Q$8:$Q$9","=Sheet1!$R$8:$R$9", "Tamers X", "black", 1.0)
    ! Add series  Y origin
    call add_line("=Sheet1!$Q$10:$Q$11","=Sheet1!$R$10:$R$11", "Tamers Y", "black", 1.0)
    ! Add series  Tamers origin
    call add_line("=Sheet1!$Q$12:$Q$15","=Sheet1!$R$12:$R$15", "Tamers area", "blue", 2.0)
    ! Add series  Zero-age line
    call add_line("=Sheet1!$Q$27:$Q$28","=Sheet1!$R$27:$R$28", "Zero-age line", "default", 2.0)
    ! Add series  Tamers origin
    call add_line("=Sheet1!$Q$30:$Q$31","=Sheet1!$R$30:$R$31", "Zero-age line (Mook)", "default", 2.0)
    
    ! UZ gas point
    series_collection = $Chart_SeriesCollection(chartA0)	
    series = SeriesCollection_NewSeries(series_collection, status)
        ! x range
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR("=Sheet1!$C6:C$6")
    vBSTR1%VU%PTR_VAL = bstr1    
    call Series_SetXValues(series, vBSTR1, status)
    status = VariantClear(vBSTR1)
    bstr1 = 0
         ! y range
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR("=Sheet1!$D6:$D6")
    vBSTR1%VU%PTR_VAL = bstr1    
    call Series_SetValues(series, vBSTR1, status)
    status = VariantClear(vBSTR1)
    bstr1 = 0   
    
         ! Name
    call Series_SetName(series, "UZ gas", status)
         ! Marker style
    call Series_SetMarkerStyle(series, xlMarkerStyleSquare, status)
    call Series_SetMarkerSize(series, 5, status)
    
         ! Series adjustments
    chart_format = Series_GetFormat(series, status)
    CALL Check_Status(status, " Unable to ChartFormat object")
        ! set fill color (prefer Excel default)
    !fill = ChartFormat_GetFill(chart_format, status)
    !CALL Check_Status(status, " Unable to get fill object")
    !color_format = FillFormat_GetForeColor(fill, status)
    !CALL Check_Status(status, " Unable to get color format object")
    !CALL ColorFormat_SetRGB(color_format, RGBTOINTEGER(0,255,0), status)
    !CALL Check_Status(status, " Unable to set fill color")
        ! Turn off line
    line_format = ChartFormat_GetLine(chart_format, status)
    CALL Check_Status(status, " Unable to LineFormat object")
    call LineFormat_SetVisible(line_format, msoFalse, status)
    CALL Check_Status(status, " Unable to set not visible")
    
    ! All data in file
    series_collection = $Chart_SeriesCollection(chartA0)	
    series = SeriesCollection_NewSeries(series_collection, status)
        ! x range
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR("=Sheet1!$C29:C$1000")
    vBSTR1%VU%PTR_VAL = bstr1    
    call Series_SetXValues(series, vBSTR1, status)
    status = VariantClear(vBSTR1)
    bstr1 = 0
         ! y range
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR("=Sheet1!$D29:$D1000")
    vBSTR1%VU%PTR_VAL = bstr1    
    call Series_SetValues(series, vBSTR1, status)
    status = VariantClear(vBSTR1)
    bstr1 = 0   
    
         ! Name
    call Series_SetName(series, "All data", status)
         ! Marker style
    call Series_SetMarkerStyle(series, xlMarkerStyleSquare, status)
    call Series_SetMarkerSize(series, 5, status)
    
         ! Series adjustments
    chart_format = Series_GetFormat(series, status)
    CALL Check_Status(status, " Unable to ChartFormat object")
        ! set fill color (prefer Excel default)
    !fill = ChartFormat_GetFill(chart_format, status)
    !CALL Check_Status(status, " Unable to get fill object")
    !color_format = FillFormat_GetForeColor(fill, status)
    !CALL Check_Status(status, " Unable to get color format object")
    !CALL ColorFormat_SetRGB(color_format, RGBTOINTEGER(0,255,0), status)
    !CALL Check_Status(status, " Unable to set fill color")
        ! Turn off line
    line_format = ChartFormat_GetLine(chart_format, status)
    CALL Check_Status(status, " Unable to LineFormat object")
    call LineFormat_SetVisible(line_format, msoFalse, status)
    CALL Check_Status(status, " Unable to set not visible")

    
    ! measured point
    series_collection = $Chart_SeriesCollection(chartA0)
    series = SeriesCollection_NewSeries(series_collection, status)
        ! x range
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR("=Sheet1!$C$3:$C$3")
    vBSTR1%VU%PTR_VAL = bstr1    
    call Series_SetXValues(series, vBSTR1, status)
    status = VariantClear(vBSTR1)
    bstr1 = 0
         ! y range
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR("=Sheet1!$D$3:$D$3")
    vBSTR1%VU%PTR_VAL = bstr1    
    call Series_SetValues(series, vBSTR1, status)
    status = VariantClear(vBSTR1)
    bstr1 = 0   
    
         ! Name
    call Series_SetName(series, "Measured", status)
         ! Marker style
    call Series_SetMarkerStyle(series, xlMarkerStyleTriangle, status)
    call Series_SetMarkerSize(series, 10, status)
    
         ! Series adjustments
    chart_format = Series_GetFormat(series, status)
    CALL Check_Status(status, " Unable to ChartFormat object")
        ! set fill color (prefer Excel default)
    !fill = ChartFormat_GetFill(chart_format, status)
    !CALL Check_Status(status, " Unable to get fill object")
    !color_format = FillFormat_GetForeColor(fill, status)
    !CALL Check_Status(status, " Unable to get color format object")
    !CALL ColorFormat_SetRGB(color_format, RGBTOINTEGER(255,0,0), status)
    !CALL Check_Status(status, " Unable to set fill color")    
        ! Turn of line
    line_format = ChartFormat_GetLine(chart_format, status)
    CALL Check_Status(status, " Unable to LineFormat object")
    call LineFormat_SetVisible(line_format, msoFalse, status)
    CALL Check_Status(status, " Unable to set not visible")    
    
    ! Put chart on worksheet   
    ! where
    CALL VariantInit(vInt)
    vInt%VT = VT_I4
    vInt%VU%LONG_VAL = xlLocationAsObject 
    ! name
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR('Sheet1')
    vBSTR1%VU%PTR_VAL = bstr1         
    ptr_return = $Chart_Location(chartA0, xlLocationAsObject, vBSTR1, status)
    CALL Check_Status(status, " Unable to set plot location")
    status = VariantClear(vBSTR1)
    bstr1 = 0 
    
    ! Move chart
    shapes = $WorkSheet_GetShapes(worksheetA0, status)
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR('Chart 1')
    vBSTR1%VU%PTR_VAL = bstr1    
    shape_range = Shapes_GetRange(shapes, vBSTR1, status) 
    CALL Check_Status(status, " Unable to get ShapeRange")     
    status = VariantClear(vBSTR1)
    bstr1 = 0   
    !call ShapeRange_IncrementLeft(shape_range, 180., status)
    call ShapeRange_IncrementLeft(shape_range, -1000., status)
    CALL Check_Status(status, " Unable to IncrementLeft")
    !call ShapeRange_IncrementTop(shape_range, -65., status) ! more negative moves chart up
    call ShapeRange_IncrementTop(shape_range, -1000., status) ! more negative moves chart up
    CALL Check_Status(status, " Unable to IncrementTop")

    ! relocate chart to corner of g5
    CALL set_rangeA0('g5','g5')
    vInt = Range_GetLeft(rangeA0, status)
    left = vInt%VU%DOUBLE_VAL
    call ShapeRange_IncrementLeft(shape_range, real(left), status)
    CALL Check_Status(status, " Unable to IncrementLeft")    
    vInt = Range_GetTop(rangeA0, status)
    top = vInt%VU%DOUBLE_VAL
    call ShapeRange_IncrementTop(shape_range, real(top), status) ! more negative moves chart up
    CALL Check_Status(status, " Unable to IncrementTop")   
    
    ! set chart size
    CALL set_rangeA0('o20','o20')
    vInt = Range_GetLeft(rangeA0, status)
    right = vInt%VU%DOUBLE_VAL
    vInt = Range_GetTop(rangeA0, status)
    bottom = vInt%VU%DOUBLE_VAL
    call ShapeRange_SetWidth(shape_range, real(right - left), status)
    call ShapeRange_SetHeight(shape_range, real(bottom - top), status)
    
    l2 = .true.
    CALL $WorkBook_SetSaved(workbookA0, l2, status)
    CALL Check_Status(status, " Unable to SetSavded")
    
    END subroutine NewExcelA0
!Subroutine NewExcelA0(c13_meas, c14_meas, &
!    c13_solid, c14_solid, &
!    c13_uz, c14_uz, &
!    a0_models, well_name)
!    USE filenames
!    USE max_size
!    USE IFQWIN
!    USE IFCOM
!    USE ADOBJECTS
!    USE excel_headings
!
!    IMPLICIT NONE   
!    integer lens
!    external lens  
!    double precision c13_meas, c14_meas, c13_solid, c14_solid, c13_uz, c14_uz
!    double precision a0_models(*)
!    character*(*) well_name
!    character*20 str, rng
!    
!    ! common blocks
!    INTEGER Wunit, Nwlls, Icase, Jele, Nodata, Isdocrs
!    COMMON /INT1  / Wunit, Nwlls, Icase, Jele(39,36), Nodata(MAXWELLS,50), &
!    Isdocrs(0:5)
!    CHARACTER Wllnms*80, Transfer*1, Model*20, Yes*3, Ion*10, Ffact*14
!    COMMON /CHAR4 / Wllnms(0:MAXWELLS), Transfer(39), Model(N_C14_MODELS), Yes(0:1), &
!    Ion(4), Ffact(0:1) 
!    DOUBLE PRECISION C14dat, Dbdata, P, Delta, Disalong, Usera
!    COMMON /DP4   / C14dat(13), Dbdata(0:MAXWELLS,0:50), P(3), Delta(40), &
!    Disalong, Usera(5)
!  
!    ! Variables
!    INTEGER*4 status
!    TYPE (VARIANT) :: template
!    INTEGER*4 loopCount
!    INTEGER*4 die1
!    INTEGER*4 die2
!    INTEGER*4 roll
!    INTEGER*4 maxScale
!    CHARACTER (LEN = 32) :: loopc
!    INTEGER*4   i, j
!    LOGICAL*2 l
!    REAL*4    rnd
!    INTEGER*2, DIMENSION(1:12) :: cellCounts
!    integer*4 excelapp1
!    integer*4 series_collection, series, series_format, ptr_return
!    integer*4 chart_format, line_format, color_format
!    integer*4 axis, chart_area, shapes, shape_range
!    integer*4 fill
!    character*10 cell_location
!    logical*2 l2
!
!    ! Variant arguments
!    TYPE (VARIANT) :: vBSTR1
!    TYPE (VARIANT) :: vBSTR2
!    TYPE (VARIANT) :: vBSTR3
!    TYPE (VARIANT) :: vBSTR4
!    TYPE (VARIANT) :: vBSTR5
!
!    TYPE (VARIANT) :: vInt
!    real max_x, max_y, data_x, data_y
!
!    ! set max for graph
!    max_x = 10
!    max_y = 100
!    data_x = -100
!    data_y = -100
!    do i = 1, Nwlls
!        if (DBDATA(i,41) .ne. 0) then
!            if (DBDATA(i,21)/DBDATA(i,41) > data_x) then
!                data_x = DBDATA(i,21)/DBDATA(i,41)
!            endif                  
!            if (DBDATA(i,22)/DBDATA(i,41) > data_y) then
!                data_y = DBDATA(i,21)/DBDATA(i,41)
!            endif
!        endif 
!    enddo    
!    do while (data_x > max_x) 
!        max_x = max_x + 10.
!    enddo 
!    do while (data_y > max_y) 
!        max_y = max_y + 10.
!    enddo     
!    ! Initialize object pointers
!    !!  CALL INITOBJECTS()
!
!    ! Create an Excel object
!    !!  CALL COMINITIALIZE(status)
!    CALL COMCreateObjectByProgID("Excel.Application", excelappA0, status)
!    IF (excelappA0 == 0) THEN
!        WRITE (*, '(" Unable to create Excel object; Aborting")')
!        CALL EXIT()
!    END IF
!    l = .TRUE.
!    CALL $Application_SetVisible(excelappA0, l)
!    CALL $Application_SetWidth(excelappA0, dble(740.), status)
!    CALL $Application_SetHeight(excelappA0, dble(630.), status)
!
!    ! Get the WORKBOOKS object
!    workbooksA0 = $Application_GetWorkbooks(excelappA0, status)
!    CALL Check_Status(status, " Unable to get WORKBOOKS object")
!
!    ! Open the specified spreadsheet file (note: specify the full file path)
!    workbookA0 = Workbooks_Add(workbooksA0,$STATUS = status )
!    CALL Check_Status(status, " Unable to get WORKBOOK object; ensure that the file path is correct")
!
!    ! Get the worksheet
!    vInt%VT = VT_I4
!    vInt%VU%LONG_VAL = 1
!    worksheetA0 = $Workbook_GetActiveSheet(workbookA0, status)
!    CALL Check_Status(status, " Unable to get WORKSHEET object")
!
!    ! set width for A, MODEL NUMBER
!    call set_rangeA0('a1','a1')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_R4
!    vBSTR1%VU%FLOAT_VAL = 16.0
!    call range_setcolumnwidth(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set column width")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0  
!
!    ! set width for B, A0 Model
!    call set_rangeA0('b1','b1')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_R4
!    vBSTR1%VU%FLOAT_VAL = 26.0
!    call range_setcolumnwidth(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set column width")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0   
!    
!    ! set width for C, 13C, permil
!    call set_rangeA0('c1','c1')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_R4
!    vBSTR1%VU%FLOAT_VAL = 10.5
!    call range_setcolumnwidth(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set column width")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0      
!    
!    ! set width for R
!    call set_rangeA0('r1','r1')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_R4
!    vBSTR1%VU%FLOAT_VAL = 30
!    call range_setcolumnwidth(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set column width")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0  
!
!    ! set decimal places for c and o
!    call set_rangeA0('c3','c100')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('0.00')    
!    vBSTR1%VU%PTR_VAL = bstr1 
!    call range_SetNumberFormat(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set decimal places")
!
!    call set_rangeA0('o3','o100')
!    call range_SetNumberFormat(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set decimal places")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0        
!
!    ! set decimal places for d and n
!    call set_rangeA0('d3','d100')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('0.0')    
!    vBSTR1%VU%PTR_VAL = bstr1 
!    call range_SetNumberFormat(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set decimal places")
!
!    call set_rangeA0('n3','n100')
!    call range_SetNumberFormat(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set decimal places")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0   
!    
!    ! Title
!    CALL setcell_characterA0('a1','Revised Fontes and Garnier (Han and Plummer, 2013)') 
!
!    ! Set header character strings
!    CALL setcell_characterA0('c2','13C, permil') 
!    CALL setcell_characterA0('d2','14C, pmc')
!
!    ! Measured, line 3
!    CALL setcell_characterA0('a3',well_name)
!    CALL setcell_characterA0('b3','Measured')
!    CALL setcell_floatA0('c3',real(c13_meas),2)
!    CALL setcell_floatA0('d3',real(c14_meas),2)
!    
!    ! Isotopic values
!    CALL setcell_characterA0('b4','Carbonate solid')
!    CALL setcell_floatA0('c4',real(c13_solid),2)
!    CALL setcell_floatA0('d4',real(c14_solid),2)
!    CALL setcell_characterA0('b5','UZ gas')
!    CALL setcell_floatA0('c5',real(c13_uz),2)
!    CALL setcell_floatA0('d5',real(c14_uz),2)
!    
!    ! Calculate origin
!    CALL setcell_characterA0('b6','Origin, X,Y')    
!    CALL set_rangeA0('c6','d6')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('=(R[-2]C+R[-1]C)/2')
!    vBSTR1%VU%PTR_VAL = bstr1     
!    CALL Range_SetFormulaR1C1(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set formula")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0       
!
!    ! Uncertainty in X (13C)
!    CALL setcell_characterA0('b7','13C Uncertainty')
!    CALL setcell_floatA0('c7',2.0,2)    
!    
!    ! Revised F&G options
!
!    CALL setcell_characterA0('a9','MODEL NUMBER')
!    CALL setcell_characterA0('b9','A0 model')
!    CALL setcell_characterA0('d9','A0, pmc')
!
!    ! Tamers
!    CALL setcell_characterA0('a10','4')
!    CALL setcell_characterA0('b10','Tamers')
!    CALL setcell_floatA0('d10',real(a0_models(4)),2)
!    CALL setcell_characterA0('f10','Use Tamers (model 4) if measured is between vertical lines')
!    
!    ! Revised F&G gas exchange
!    CALL setcell_characterA0('a11','10')
!    CALL setcell_characterA0('b11','Revised F&G, Gas exchange')
!    CALL setcell_floatA0('d11',real(a0_models(10)),2)
!    CALL setcell_characterA0('f11','Use gas exchange (model 10) if measured is left of vertical lines')
!    
!    ! Revised F&G solid exchange
!    CALL setcell_characterA0('a12','11')
!    CALL setcell_characterA0('b12','Revised F&G, Solid exchange')
!    CALL setcell_floatA0('d12',real(a0_models(11)),2)
!    CALL setcell_characterA0('f12','Use solid exchange (model 11) if measured is right of vertical lines')
!
!    ! Origin X, x values
!    CALL setcell_characterA0('n3','Origin X')
!    CALL set_rangeA0('o3','o3')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('=R[3]C[-12]')
!    vBSTR1%VU%PTR_VAL = bstr1     
!    CALL Range_SetFormulaR1C1(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set formula")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0  
!    
!    CALL set_rangeA0('o4','o4')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('=R[-1]')
!    vBSTR1%VU%PTR_VAL = bstr1     
!    CALL Range_SetFormulaR1C1(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set formula")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0 
!    
!    ! Origin X, y values
!    CALL setcell_floatA0('p3',0.0,2)
!    CALL setcell_floatA0('p4',max_y,2)     
!    
!    ! Origin Y, x values
!    CALL setcell_characterA0('n6','Origin Y')
!    CALL setcell_floatA0('o6',-30.,2)
!    CALL setcell_floatA0('o7',max_x,2)
!    
!    ! Origin Y, y values
!    CALL set_rangeA0('p6','p6')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('=R[0]C[-12]')
!    vBSTR1%VU%PTR_VAL = bstr1     
!    CALL Range_SetFormulaR1C1(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set formula")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0 
!    
!    CALL set_rangeA0('p7','p7')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('=R[-1]')
!    vBSTR1%VU%PTR_VAL = bstr1     
!    CALL Range_SetFormulaR1C1(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set formula")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0    
!    
!    ! Tamers lines
!        ! right
!    CALL setcell_characterA0('n9','Tamers')
!    CALL set_rangeA0('o9','o9')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('=R[-6] + R[-2]C[-12]')
!    vBSTR1%VU%PTR_VAL = bstr1     
!    CALL Range_SetFormulaR1C1(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set formula")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0   
!    CALL setcell_floatA0('p9',0.,2)
!    
!    CALL set_rangeA0('o10','o10')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('=R[-1]')
!    vBSTR1%VU%PTR_VAL = bstr1     
!    CALL Range_SetFormulaR1C1(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set formula")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0 
!    CALL setcell_floatA0('p10',max_y,2)
!    
!        ! left
!    CALL set_rangeA0('o11','o11')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('=R[-8] - R[-4]C[-12]')
!    vBSTR1%VU%PTR_VAL = bstr1     
!    CALL Range_SetFormulaR1C1(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set formula")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0  
!    CALL setcell_floatA0('p11',max_y,2)
!    
!    CALL set_rangeA0('o12','o12')
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('=R[-1]')
!    vBSTR1%VU%PTR_VAL = bstr1     
!    CALL Range_SetFormulaR1C1(rangeA0, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set formula")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0  
!    CALL setcell_floatA0('p12',0.,2) 
!    
!    ! Put all 13C, 14C data in spreadsheet for plot
!     CALL setcell_characterA0('R1','Well name')
!     CALL setcell_characterA0('S1','13C')
!     CALL setcell_characterA0('T1','14C')
!     do i = 1, Nwlls
!         write(str,'(I3)') i+1
!         call left_trim(str)
!         rng = 'R' // str
!         call setcell_characterA0(rng(1:lens(rng)), Wllnms(i))
!         if (DBDATA(i,41) .ne. 0) then
!            rng = 'S' // str
!            CALL setcell_floatA0(rng(1:lens(rng)), real(DBDATA(i,21)/DBDATA(i,41)), 2)
!            rng = 'T' // str
!            CALL setcell_floatA0(rng(1:lens(rng)), real(DBDATA(i,22)/DBDATA(i,41)), 2)            
!         endif 
!     enddo
!    
!    ! Generate plot
!    !CALL set_rangeA0('o9','p10')
!    chartsA0 = $Workbook_GetCharts(workbookA0, $STATUS = status)
!    CALL Check_Status(status, " Unable to get CHARTS object")
!    chartA0 = Charts_Add(chartsA0, $STATUS = status)
!    CALL Check_Status(status, " Unable to add CHART object")
!
!    ! plot type
!    CALL VariantInit(vInt)
!    vInt%VT = VT_I4
!    vInt%VU%LONG_VAL = xlXYScatterLinesNoMarkers
!    ! title
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR("Han and Plummer Plot")
!    vBSTR1%VU%PTR_VAL = bstr1
!    ! X axis
!    CALL VariantInit(vBSTR2)
!    vBSTR2%VT = VT_BSTR
!    bstr2 = ConvertStringToBSTR("Carbon-13, permil")
!    vBSTR2%VU%PTR_VAL = bstr2
!    ! Y axis
!    CALL VariantInit(vBSTR3)
!    vBSTR3%VT = VT_BSTR
!    bstr3 = ConvertStringToBSTR("Carbon-14, pmc")
!    vBSTR3%VU%PTR_VAL = bstr3
!    ! Chart wizard
!    CALL $Chart_ChartWizard(chartA0, &
!        Gallery = vInt, &
!        Title = vBSTR1, &
!        CategoryTitle = vBSTR2, &
!        ValueTitle = vBSTR3, &
!        $STATUS = status)
!    CALL Check_Status(status, " Unable to invoke ChartWizard")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0
!    status = VariantClear(vBSTR2)
!    bstr2 = 0
!    status = VariantClear(vBSTR3)
!    bstr3 = 0
!    
!    ! set X bounds
!    CALL VariantInit(vInt)
!    vInt%VT = VT_I4
!    vInt%VU%LONG_VAL = xlCategory
!    axis = $Chart_Axes(chartA0, vInt, xlPrimary, status)
!    CALL Check_Status(status, " Unable to get axes")
!    call Axis_SetMinimumScale(axis, dble(-30), status)
!    CALL Check_Status(status, " Unable to set MinimumScale")
!    call Axis_SetMaximumScale(axis, dble(max_x), status)
!    CALL Check_Status(status, " Unable to set MaximumScale")
!    call Axis_SetMajorUnit(axis, dble(10), status)
!    CALL Check_Status(status, " Unable to set MajorUnit")
!    call Axis_SetMinorUnit(axis, dble(2), status)
!    CALL Check_Status(status, " Unable to set MinorUnit")
!    call Axis_SetCrossesAt(axis, dble(-30), status)
!    CALL Check_Status(status, " Unable to set CrossesAt")
!    call Axis_SetMajorTickMark(axis, xlInside, status)
!    CALL Check_Status(status, " Unable to set MajorTickMark")
!    call Axis_SetMinorTickMark(axis, xlInside, status)
!    CALL Check_Status(status, " Unable to set MinorTickMark")
!    ! Turn off gridlines
!    call Axis_SetHasMajorGridlines(axis, .false., status)
!    CALL Check_Status(status, " Unable to set SetHasMajorGridlines")
!    
!     ! set Y bounds
!    CALL VariantInit(vInt)
!    vInt%VT = VT_I4
!    vInt%VU%LONG_VAL = xlValue
!    axis = $Chart_Axes(chartA0, vInt, xlPrimary, status)
!    CALL Check_Status(status, " Unable to get axes")
!    call Axis_SetMinimumScale(axis, dble(0), status)
!    CALL Check_Status(status, " Unable to set MinimumScale")
!    call Axis_SetMaximumScale(axis, dble(max_y), status)
!    CALL Check_Status(status, " Unable to set MaximumScale")
!    call Axis_SetMajorUnit(axis, dble(10), status)
!    CALL Check_Status(status, " Unable to set MajorUnit")
!    call Axis_SetMinorUnit(axis, dble(5), status) 
!    CALL Check_Status(status, " Unable to set MinorUnit")  
!    call Axis_SetMajorTickMark(axis, xlInside, status)
!    CALL Check_Status(status, " Unable to set MajorTickMark")
!    call Axis_SetMinorTickMark(axis, xlInside, status)
!    CALL Check_Status(status, " Unable to set MinorTickMark")
!    ! Turn off gridlines
!    call Axis_SetHasMajorGridlines(axis, .false., status)
!    CALL Check_Status(status, " Unable to set SetHasMajorGridlines")
!    
!    ! Delete series
!    CALL VariantInit(vInt)
!    vInt%VT = VT_I4
!    vInt%VU%LONG_VAL = 1
!    series_collection = $Chart_SeriesCollection(chartA0)
!    series = SeriesCollection_Item(series_collection, vInt, status)
!    CALL Check_Status(status, " Unable to find default series")
!    vInt = Series_Delete(series, status)
!    CALL Check_Status(status, " Unable to delete default series")
!    
!    ! Add series  X origin
!    call add_line("=Sheet1!$O$3:$O$4","=Sheet1!$P$3:$P$4", "X origin", "black", 1.0)
!    ! Add series  Y origin
!    call add_line("=Sheet1!$O$6:$O$7","=Sheet1!$P$6:$P$7", "Y origin", "black", 1.0)
!    ! Add series  Tamers left
!    call add_line("=Sheet1!$O$11:$O$12","=Sheet1!$P$11:$P$12", "Tamers left", "blue", 2.0)
!    ! Add series  Tamers right
!    call add_line("=Sheet1!$O$9:$O$10","=Sheet1!$P$9:$P$10", "Tamers right", "blue", 2.0)
!    
!    ! All data in file
!    series_collection = $Chart_SeriesCollection(chartA0)	
!    series = SeriesCollection_NewSeries(series_collection, status)
!        ! x range
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR("=Sheet1!$S2:S$1000")
!    vBSTR1%VU%PTR_VAL = bstr1    
!    call Series_SetXValues(series, vBSTR1, status)
!    status = VariantClear(vBSTR1)
!    bstr1 = 0
!         ! y range
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR("=Sheet1!$T2:$T1000")
!    vBSTR1%VU%PTR_VAL = bstr1    
!    call Series_SetValues(series, vBSTR1, status)
!    status = VariantClear(vBSTR1)
!    bstr1 = 0   
!    
!         ! Name
!    call Series_SetName(series, "All data", status)
!         ! Marker style
!    call Series_SetMarkerStyle(series, xlMarkerStyleSquare, status)
!    call Series_SetMarkerSize(series, 5, status)
!    
!         ! Series adjustments
!    chart_format = Series_GetFormat(series, status)
!    CALL Check_Status(status, " Unable to ChartFormat object")
!        ! set fill color (prefer Excel default)
!    !fill = ChartFormat_GetFill(chart_format, status)
!    !CALL Check_Status(status, " Unable to get fill object")
!    !color_format = FillFormat_GetForeColor(fill, status)
!    !CALL Check_Status(status, " Unable to get color format object")
!    !CALL ColorFormat_SetRGB(color_format, RGBTOINTEGER(0,255,0), status)
!    !CALL Check_Status(status, " Unable to set fill color")
!        ! Turn off line
!    line_format = ChartFormat_GetLine(chart_format, status)
!    CALL Check_Status(status, " Unable to LineFormat object")
!    call LineFormat_SetVisible(line_format, msoFalse, status)
!    CALL Check_Status(status, " Unable to set not visible")
!
!    ! measured point
!    series_collection = $Chart_SeriesCollection(chartA0)	
!    series = SeriesCollection_NewSeries(series_collection, status)
!        ! x range
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR("=Sheet1!$C$3:$C$3")
!    vBSTR1%VU%PTR_VAL = bstr1    
!    call Series_SetXValues(series, vBSTR1, status)
!    status = VariantClear(vBSTR1)
!    bstr1 = 0
!         ! y range
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR("=Sheet1!$D$3:$D$3")
!    vBSTR1%VU%PTR_VAL = bstr1    
!    call Series_SetValues(series, vBSTR1, status)
!    status = VariantClear(vBSTR1)
!    bstr1 = 0   
!    
!         ! Name
!    call Series_SetName(series, "Measured", status)
!         ! Marker style
!    call Series_SetMarkerStyle(series, xlMarkerStyleTriangle, status)
!    call Series_SetMarkerSize(series, 10, status)
!    
!         ! Series adjustments
!    chart_format = Series_GetFormat(series, status)
!    CALL Check_Status(status, " Unable to ChartFormat object")
!        ! set fill color (prefer Excel default)
!    !fill = ChartFormat_GetFill(chart_format, status)
!    !CALL Check_Status(status, " Unable to get fill object")
!    !color_format = FillFormat_GetForeColor(fill, status)
!    !CALL Check_Status(status, " Unable to get color format object")
!    !CALL ColorFormat_SetRGB(color_format, RGBTOINTEGER(255,0,0), status)
!    !CALL Check_Status(status, " Unable to set fill color")    
!        ! Turn of line
!    line_format = ChartFormat_GetLine(chart_format, status)
!    CALL Check_Status(status, " Unable to LineFormat object")
!    call LineFormat_SetVisible(line_format, msoFalse, status)
!    CALL Check_Status(status, " Unable to set not visible")    
!    
!    ! Put chart on worksheet   
!    ! where
!    CALL VariantInit(vInt)
!    vInt%VT = VT_I4
!    vInt%VU%LONG_VAL = xlLocationAsObject 
!    ! name
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('Sheet1')
!    vBSTR1%VU%PTR_VAL = bstr1         
!    ptr_return = $Chart_Location(chartA0, xlLocationAsObject, vBSTR1, status)
!    CALL Check_Status(status, " Unable to set plot location")
!    status = VariantClear(vBSTR1)
!    bstr1 = 0 
!    
!    ! Move chart
!    shapes = $WorkSheet_GetShapes(worksheetA0, status)
!    CALL VariantInit(vBSTR1)
!    vBSTR1%VT = VT_BSTR
!    bstr1 = ConvertStringToBSTR('Chart 1')
!    vBSTR1%VU%PTR_VAL = bstr1    
!    shape_range = Shapes_GetRange(shapes, vBSTR1, status) 
!    CALL Check_Status(status, " Unable to get ShapeRange")     
!    status = VariantClear(vBSTR1)
!    bstr1 = 0   
!    call ShapeRange_IncrementLeft(shape_range, -14., status)
!    CALL Check_Status(status, " Unable to IncrementLeft")
!    call ShapeRange_IncrementTop(shape_range, 75., status)
!    CALL Check_Status(status, " Unable to IncrementTop")
!    
!    l2 = .true.
!    CALL $WorkBook_SetSaved(workbookA0, l2, status)
!    CALL Check_Status(status, " Unable to SetSavded")
!    
!    END subroutine NewExcelA0
    
    
    subroutine add_line(rangex_str, rangey_str, title_str, color_str, weight)
    USE IFQWIN
    USE IFCOM
    USE ADOBJECTS
    implicit none
    INTEGER*4 status
    TYPE (VARIANT) :: vBSTR1
    REAL weight
    
    character*(*) rangex_str, rangey_str, title_str, color_str
    integer*4 series_collection, series, chart_format, line_format, color_format 
    series_collection = $Chart_SeriesCollection(chartA0)	
    series = SeriesCollection_NewSeries(series_collection, status)
        ! x range
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR(rangex_str)
    vBSTR1%VU%PTR_VAL = bstr1    
    call Series_SetXValues(series, vBSTR1, status)
    status = VariantClear(vBSTR1)
    bstr1 = 0
         ! y range
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR(rangey_str)
    vBSTR1%VU%PTR_VAL = bstr1    
    call Series_SetValues(series, vBSTR1, status)
    status = VariantClear(vBSTR1)
    bstr1 = 0   
        ! Name
    call Series_SetName(series, title_str, status)

    ! Line format
    chart_format = Series_GetFormat(series, status)
    CALL Check_Status(status, " Unable to ChartFormat object")

    line_format = ChartFormat_GetLine(chart_format, status)
    CALL Check_Status(status, " Unable to LineFormat object")
    call LineFormat_SetWeight(line_format, weight)
    
    color_format = LineFormat_GetForeColor(line_format, status)
    CALL Check_Status(status, " Unable to get ColorFormat object")
    
    if (trim(color_str) .eq. 'black') then
        CALL ColorFormat_SetRGB(color_format, 0)
    elseif (trim(color_str) .eq. 'blue') then
        CALL ColorFormat_SetRGB(color_format, RGBTOINTEGER(0,0,255))
    elseif (trim(color_str) .eq. 'green') then
        CALL ColorFormat_SetRGB(color_format, RGBTOINTEGER(0,255,0))
    elseif (trim(color_str) .eq. 'red') then
        CALL ColorFormat_SetRGB(color_format, RGBTOINTEGER(255,0,0))
    endif
    
    end subroutine add_line
    
    subroutine left_trim(string)
    character*(*) string
    integer i, j, l
    l = lens(string)
    if (l .eq. 0) return
    j = 1
    do i = 1, lens(string)
        if (string(i:i) .eq. ' ') then
            j = j + 1
        else
            string = string(j:l)
            exit
        endif
    enddo
    return
    end subroutine left_trim
    
    Subroutine set_column_width(w)
    ! assumes rangeA0 is set
    use ADOBJECTS
    implicit none
    real w
	TYPE (VARIANT) :: vBSTR1
    integer status
    
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_R4
    vBSTR1%VU%FLOAT_VAL = w
    call range_setcolumnwidth(rangeA0, vBSTR1, status)
    CALL Check_Status(status, " Unable to set column width")
    status = VariantClear(vBSTR1)
    end subroutine set_column_width 

    Subroutine set_decimal_places(str)
    ! assumes rangeA0 is set
    USE IFQWIN
    USE IFCOM    
    USE ADOBJECTS
    implicit none
    character*(*) str
	TYPE (VARIANT) :: vBSTR1
    integer status
    !INTEGER*4 bstr1
    
    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR(str)    
    vBSTR1%VU%PTR_VAL = bstr1 
    call range_SetNumberFormat(rangeA0, vBSTR1, status)
    CALL Check_Status(status, " Unable to set decimal places")
    status = VariantClear(vBSTR1)
    bstr1 = 0
    end subroutine set_decimal_places
  
    Subroutine set_formula(str)
    ! assumes rangeA0 is set
    USE IFQWIN
    USE IFCOM    
    USE ADOBJECTS
    implicit none
    character*(*) str
	TYPE (VARIANT) :: vBSTR1
    integer status

    CALL VariantInit(vBSTR1)
    vBSTR1%VT = VT_BSTR
    bstr1 = ConvertStringToBSTR(str)
    vBSTR1%VU%PTR_VAL = bstr1     
    CALL Range_SetFormulaR1C1(rangeA0, vBSTR1, status)
    CALL Check_Status(status, " Unable to set formula")
    status = VariantClear(vBSTR1)
    bstr1 = 0  
    end Subroutine set_formula
    
    Subroutine set_fill(color)
    ! assumes rangeA0 is set
    USE IFQWIN
    USE IFCOM    
    USE ADOBJECTS
    implicit none
	TYPE (VARIANT) :: vInt
    integer*4 interior
    integer*4 status
    integer*4 color
    
    interior = range_GetInterior(rangeA0, status)
    CALL Check_Status(status, " Unable to get interior")
        ! pattern
    vInt%VT = VT_I4
    vInt%VU%LONG_VAL = xlSolid  
    call Interior_SetPattern(interior, vInt, status)
        ! PatternColorIndex
    vInt%VT = VT_I4
    vInt%VU%LONG_VAL = xlAutomatic  
    call Interior_SetPatternColorIndex(interior, vInt, status)
        ! Color
    vInt%VT = VT_I4
    vInt%VU%LONG_VAL = color  
    call Interior_SetColor(interior, vInt, status)
    return
    end Subroutine set_fill